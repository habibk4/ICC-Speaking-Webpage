<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>جعبه لایتنر دوره ICC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        }
        .main-container {
            flex-grow: 1;
            padding: 1rem;
        }
        .flashcard-container {
            perspective: 1000px;
            height: 280px;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }
        .flashcard {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.7s ease-in-out;
            transform-style: preserve-3d;
            cursor: pointer;
        }
        .flashcard.is-flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            text-align: center;
            background-color: #ffffff;
        }
        .card-front {
            border: 1px solid #d1d5db;
        }
        .card-back {
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            transform: rotateY(180deg);
            font-size: 0.95rem;
            line-height: 1.7;
            overflow: hidden;
        }
        .pronunciation-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding: 0.75rem 1.5rem;
            background-color: #dbeafe;
            color: #1e40af;
            border-radius: 9999px;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .pronunciation-button:hover {
            background-color: #bfdbfe;
            transform: translateY(-2px);
        }
        .box-count {
            background-color: #1e40af;
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }
        .box.active {
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
        }
        .box {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: all 0.3s ease;
        }
        .box:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .card-back-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 1rem 1rem 0 0;
        }
        /* Modal Styles */
        #login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        #login-modal.show {
            opacity: 1;
            visibility: visible;
        }
        #login-modal .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 90%;
            width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        #login-modal.show .modal-content {
            transform: translateY(0);
        }
        /* Responsive Adjustments */
        @media (max-width: 640px) {
            .main-container {
                padding: 0.5rem;
            }
            .flashcard-container {
                height: 220px;
                max-width: 100%;
            }
            .card-face {
                padding: 1rem;
                font-size: 0.9rem;
            }
            .card-back-image {
                height: 80px;
            }
            .pronunciation-button {
                padding: 0.5rem 1rem;
                font-size: 0.85rem;
            }
            .box {
                padding: 0.75rem;
            }
            .box-count {
                width: 28px;
                height: 28px;
                font-size: 0.9rem;
            }
            h1 {
                font-size: 1.25rem;
            }
            #review-message {
                font-size: 1rem;
            }
            #answer-buttons button {
                padding: 0.5rem 1.5rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body class="text-gray-900">

    <div class="main-container container mx-auto max-w-6xl p-4 sm:p-6 md:p-8">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">جعبه لایتنر دوره ICC</h1>
            <div id="auth-container">
                <button id="login-button" class="px-4 py-2 text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-all duration-300 hidden">
                    ورود با گوگل
                </button>
                <div id="user-profile-actions" class="flex items-center gap-4 hidden">
                    <!-- User info will be injected here -->
                </div>
            </div>
        </header>

        <div id="app-container" class="bg-white rounded-2xl shadow-lg p-4 sm:p-6 md:p-8">
            <div id="boxes-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 mb-8"></div>
            <div id="review-area" class="w-full mx-auto text-center hidden">
                <p id="review-message" class="text-lg sm:text-xl font-semibold text-gray-800 mb-6"></p>
                <div id="flashcard-display" class="flashcard-container mx-auto mb-6">
                    <div class="flashcard">
                        <div id="card-front" class="card-face card-front"></div>
                        <div id="card-back" class="card-face card-back p-0"></div>
                    </div>
                </div>
                <div id="answer-buttons" class="flex justify-center gap-4 sm:gap-6 hidden">
                    <button id="correct-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 sm:py-3 px-6 sm:px-8 rounded-lg transition-all duration-300">درست</button>
                    <button id="incorrect-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 sm:py-3 px-6 sm:px-8 rounded-lg transition-all duration-300">غلط</button>
                </div>
            </div>
            <div id="no-review-message" class="text-center py-8 sm:py-10 px-4 bg-gray-50 rounded-lg">
                <p class="text-lg sm:text-xl font-semibold text-gray-700">برای شروع، یک جعبه را انتخاب کنید.</p>
            </div>
            <div class="text-center mt-6 sm:mt-8">
                <button id="reset-progress" class="text-sm text-gray-500 hover:text-red-600 hover:underline transition-colors duration-300">شروع مجدد و پاک کردن تمام پیشرفت</button>
            </div>
        </div>
    </div>
    
    <!-- Login Modal -->
    <div id="login-modal" class="hidden">
        <div class="modal-content">
            <div class="flex justify-end">
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="flex justify-center mb-4">
                <svg class="w-12 h-12 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </div>
            <p class="font-bold text-lg sm:text-xl text-gray-800 mb-2">برای ذخیره پیشرفت خود وارد شوید!</p>
            <p class="text-sm sm:text-base text-gray-600 mb-6">با ورود از طریق گوگل، اطلاعات جعبه لایتنر شما به صورت آنلاین ذخیره می‌شود و از هر دستگاهی قابل دسترس خواهد بود.</p>
            <button id="modal-login-btn" class="px-6 py-2 text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-all duration-300">ورود با گوگل</button>
        </div>
    </div>

    <footer class="text-center p-4 mt-auto text-gray-600 text-sm">
        <p>طراحی و توسعه حبیب کمایی</p>
        <p>Habibkamaie@gmail.com</p>
    </footer>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDJf9qVKxynq0LpGcB3kn9Rk7s9HsR1ppw",
            authDomain: "icc-speaking-bd474.firebaseapp.com",
            projectId: "icc-speaking-bd474",
            storageBucket: "icc-speaking-bd474.appspot.com",
            messagingSenderId: "818278585317",
            appId: "1:818278585317:web:70a1b32846af0a342e950c"
        };

        // --- Initialize Firebase ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const provider = new firebase.auth.GoogleAuthProvider();

        document.addEventListener('DOMContentLoaded', function () {
            // --- UI Elements ---
            const loginButton = document.getElementById('login-button');
            const modalLoginButton = document.getElementById('modal-login-btn');
            const userProfileActions = document.getElementById('user-profile-actions');
            const loginModal = document.getElementById('login-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const correctBtn = document.getElementById('correct-btn');
            const incorrectBtn = document.getElementById('incorrect-btn');
            let listenersAttached = false;

            // --- DATA ---
            const allCardsData = [
                { id: 1, front: 'سه سوته / In a jiffy', back_fa: 'خیلی سریع.', back_en: "I'll be back in a jiffy, just wait here.", text_to_speak: "In a jiffy", image_url: "https://placehold.co/400x200/3B82F6/FFFFFF?text=Fast+Clock" },
                { id: 2, front: 'دو دلم / On the fence', back_fa: 'مردد بودن.', back_en: "I'm on the fence about accepting the new job offer.", text_to_speak: "On the fence", image_url: "https://placehold.co/400x200/10B981/FFFFFF?text=Question+Mark" },
                { id: 3, front: 'Never in a million years', back_fa: 'هرگز، عمراً.', back_en: "Never in a million years would I have guessed the surprise.", text_to_speak: "Never in a million years", image_url: "https://placehold.co/400x200/8B5CF6/FFFFFF?text=Impossible" },
                { id: 4, front: 'Cost an arm and a leg', back_fa: 'خیلی گران بودن.', back_en: "That new designer handbag cost her an arm and a leg.", text_to_speak: "Cost an arm and a leg", image_url: "https://placehold.co/400x200/EF4444/FFFFFF?text=Expensive" },
                { id: 5, front: 'It is what it is', back_fa: 'شرایط همین است (کاری نمی‌توان کرد).', back_en: "We can't change the past. It is what it is.", text_to_speak: "It is what it is", image_url: "https://placehold.co/400x200/6B7280/FFFFFF?text=Acceptance" },
                { id: 6, front: 'Take it or leave it', back_fa: 'پیشنهاد نهایی (یا قبول کن یا رد کن).', back_en: "This is my last offer. Take it or leave it.", text_to_speak: "Take it or leave it", image_url: "https://placehold.co/400x200/F97316/FFFFFF?text=Final+Offer" },
                { id: 7, front: 'Take a hike', back_fa: 'برو گمشو (بی‌ادبانه).', back_en: "He told his noisy neighbors to take a hike.", text_to_speak: "Take a hike", image_url: "https://placehold.co/400x200/D97706/FFFFFF?text=Go+Away" },
                { id: 8, front: 'Backbiting', back_fa: 'پشت سر کسی بدگویی کردن.', back_en: "I hate office politics and backbiting.", text_to_speak: "Backbiting", image_url: "https://placehold.co/400x200/4B5563/FFFFFF?text=Whispers" },
                { id: 9, front: 'Catch red-handed', back_fa: 'مچ کسی را حین ارتکاب جرم گرفتن.', back_en: "The manager caught the employee red-handed stealing office supplies.", text_to_speak: "Catch red-handed", image_url: "https://placehold.co/400x200/DC2626/FFFFFF?text=Caught!" },
                { id: 10, front: "Don't count your chickens before they hatch", back_fa: 'جوجه را آخر پاییز می‌شمارند.', back_en: "You may get the job, but don't count your chickens before they hatch.", text_to_speak: "Don't count your chickens before they hatch", image_url: "https://placehold.co/400x200/F59E0B/FFFFFF?text=Patience" },
                { id: 11, front: "A friend in need is a friend indeed", back_fa: 'دوست واقعی در سختی‌ها شناخته می‌شود.', back_en: "She helped me when I was broke. A friend in need is a friend indeed.", text_to_speak: "A friend in need is a friend indeed", image_url: "https://placehold.co/400x200/22C55E/FFFFFF?text=True+Friend" },
                { id: 12, front: 'The milk boiled over', back_fa: 'شیر سر رفت.', back_en: "I was on the phone and the milk boiled over.", text_to_speak: "The milk boiled over", image_url: "https://placehold.co/400x200/9CA3AF/FFFFFF?text=Spilled+Milk" },
                { id: 13, front: 'The power went out', back_fa: 'برق رفت.', back_en: "The power went out, and everything went dark.", text_to_speak: "The power went out", image_url: "https://placehold.co/400x200/1F2937/FFFFFF?text=Blackout" },
                { id: 14, front: 'Its battery died', back_fa: 'باتری‌اش تمام شد.', back_en: "My phone's battery died during the important call.", text_to_speak: "Its battery died", image_url: "https://placehold.co/400x200/78716C/FFFFFF?text=Empty+Battery" },
                { id: 15, front: 'Tapped me on the shoulder', back_fa: 'به شانه‌ام زد.', back_en: "A stranger tapped me on the shoulder to ask for directions.", text_to_speak: "Tapped me on the shoulder", image_url: "https://placehold.co/400x200/06B6D4/FFFFFF?text=Friendly+Tap" },
                { id: 16, front: 'Fell asleep', back_fa: 'خوابم برد.', back_en: "After a long day, I fell asleep immediately.", text_to_speak: "Fell asleep", image_url: "https://placehold.co/400x200/4338CA/FFFFFF?text=Sleeping" },
                { id: 17, front: 'Cut my finger', back_fa: 'انگشتم را بریدم.', back_en: "Be careful with that knife, I just cut my finger.", text_to_speak: "Cut my finger", image_url: "https://placehold.co/400x200/BE123C/FFFFFF?text=Ouch!" },
                { id: 18, front: 'Sprained my ankle', back_fa: 'مچ پایم پیچ خورد.', back_en: "I slipped on the ice and sprained my ankle.", text_to_speak: "Sprained my ankle", image_url: "https://placehold.co/400x200/9A3412/FFFFFF?text=Ankle+Injury" },
                { id: 19, front: 'To haggle', back_fa: 'چانه زدن.', back_en: "In many markets, you are expected to haggle over the price.", text_to_speak: "To haggle", image_url: "https://placehold.co/400x200/059669/FFFFFF?text=Bargain" },
                { id: 20, front: 'Passed out', back_fa: 'غش کرد، از هوش رفت.', back_en: "He passed out from the heat.", text_to_speak: "Passed out", image_url: "https://placehold.co/400x200/A1A1AA/FFFFFF?text=Fainted" },
                { id: 21, front: 'My car broke down', back_fa: 'ماشینم خراب شد.', back_en: "My car broke down in the middle of the highway.", text_to_speak: "My car broke down", image_url: "https://placehold.co/400x200/57534E/FFFFFF?text=Car+Trouble" },
                { id: 22, front: 'I had an accident', back_fa: 'تصادف کردم.', back_en: "I had an accident on my way here, so I'm a bit late.", text_to_speak: "I had an accident", image_url: "https://placehold.co/400x200/B91C1C/FFFFFF?text=Crash" },
                { id: 23, front: 'Someone knocked at the door', back_fa: 'یکی در زد.', back_en: "I was watching a movie when someone knocked at the door.", text_to_speak: "Someone knocked at the door", image_url: "https://placehold.co/400x200/A16207/FFFFFF?text=Knock+Knock" },
                { id: 24, front: 'Dust', back_fa: 'اسم: گرد و خاک. فعل: گردگیری کردن.', back_en: "I need to dust the shelves before the guests arrive.", text_to_speak: "Dust", image_url: "https://placehold.co/400x200/D6D3D1/000000?text=Dusting" },
                { id: 25, front: 'Cockroach', back_fa: 'سوسک.', back_en: "He screamed when he saw a cockroach in the bathroom.", text_to_speak: "Cockroach", image_url: "https://placehold.co/400x200/3F3F46/FFFFFF?text=Cockroach" },
                { id: 26, front: 'Cheat', back_fa: 'تقلب کردن.', back_en: "The teacher warned the students not to cheat on the exam.", text_to_speak: "Cheat", image_url: "https://placehold.co/400x200/7F1D1D/FFFFFF?text=Cheating" },
                { id: 27, front: 'Whispering', back_fa: 'پچ‌پچ کردن.', back_en: "They were whispering so no one else could hear.", text_to_speak: "Whispering", image_url: "https://placehold.co/400x200/52525B/FFFFFF?text=Secret" },
                { id: 28, front: 'Shouting', back_fa: 'داد زدن.', back_en: "Please stop shouting, I'm right here.", text_to_speak: "Shouting", image_url: "https://placehold.co/400x200/E11D48/FFFFFF?text=Loud!" },
                { id: 29, front: 'Yawning', back_fa: 'خمیازه کشیدن.', back_en: "His constant yawning showed how bored he was.", text_to_speak: "Yawning", image_url: "https://placehold.co/400x200/0891B2/FFFFFF?text=Tired" },
                { id: 30, front: 'Ogling', back_fa: 'چشم‌چرانی کردن، دید زدن.', back_en: "The man was rudely ogling the people at the next table.", text_to_speak: "Ogling", image_url: "https://placehold.co/400x200/BE185D/FFFFFF?text=Staring" },
                { id: 31, front: 'Whistling', back_fa: 'سوت زدن.', back_en: "He walked down the street, whistling a cheerful tune.", text_to_speak: "Whistling", image_url: "https://placehold.co/400x200/1D4ED8/FFFFFF?text=Music" },
                { id: 32, front: 'داشتم به خانه می‌رفتم.', back_fa: 'I was going home.', back_en: '', text_to_speak: 'I was going home', image_url: "https://placehold.co/400x200/16A34A/FFFFFF?text=Going+Home" },
                { id: 33, front: 'داشتم رانندگی می‌کردم.', back_fa: 'I was driving.', back_en: '', text_to_speak: 'I was driving', image_url: "https://placehold.co/400x200/4F46E5/FFFFFF?text=Driving" },
                { id: 34, front: 'داشتم به مادرم کمک می‌کردم.', back_fa: 'I was helping my mother.', back_en: '', text_to_speak: 'I was helping my mother', image_url: "https://placehold.co/400x200/DB2777/FFFFFF?text=Helping" },
                { id: 35, front: 'داشتم آشپزی می‌کردم.', back_fa: 'I was cooking.', back_en: '', text_to_speak: 'I was cooking', image_url: "https://placehold.co/400x200/F59E0B/FFFFFF?text=Cooking" },
                { id: 36, front: 'داشتم حیاط را جارو می‌کردم.', back_fa: 'I was sweeping the yard.', back_en: '', text_to_speak: 'I was sweeping the yard', image_url: "https://placehold.co/400x200/9A3412/FFFFFF?text=Sweeping" },
                { id: 37, front: 'داشتم ماشینم را پارک می‌کردم.', back_fa: 'I was parking my car.', back_en: '', text_to_speak: 'I was parking my car', image_url: "https://placehold.co/400x200/64748B/FFFFFF?text=Parking" },
                { id: 38, front: 'داشتم شام را سرو می‌کردم.', back_fa: 'I was serving the dinner.', back_en: '', text_to_speak: 'I was serving the dinner', image_url: "https://placehold.co/400x200/7C2D12/FFFFFF?text=Serving+Dinner" },
                { id: 39, front: 'داشتم میز را می‌چیدم.', back_fa: 'I was setting the table.', back_en: '', text_to_speak: 'I was setting the table', image_url: "https://placehold.co/400x200/065F46/FFFFFF?text=Setting+Table" },
                { id: 40, front: 'آنها داشتند تنیس بازی می‌کردند.', back_fa: 'They were playing tennis.', back_en: '', text_to_speak: 'They were playing tennis', image_url: "https://placehold.co/400x200/15803D/FFFFFF?text=Tennis" },
                { id: 41, front: 'داشتم دندان‌هایم را مسواک می‌زدم.', back_fa: 'I was brushing my teeth.', back_en: '', text_to_speak: 'I was brushing my teeth', image_url: "https://placehold.co/400x200/0E7490/FFFFFF?text=Brushing+Teeth" },
                { id: 42, front: 'داشتم با تلفن صحبت می‌کردم.', back_fa: 'I was talking on the phone.', back_en: '', text_to_speak: 'I was talking on the phone', image_url: "https://placehold.co/400x200/BE185D/FFFFFF?text=Phone+Call" },
                { id: 43, front: 'داشتیم تلویزیون تماشا می‌کردیم.', back_fa: 'We were watching TV.', back_en: '', text_to_speak: 'We were watching TV', image_url: "https://placehold.co/400x200/5B21B6/FFFFFF?text=Watching+TV" },
                { id: 44, front: 'داشتم ظرف‌ها را می‌شستم.', back_fa: 'I was washing the dishes.', back_en: '', text_to_speak: 'I was washing the dishes', image_url: "https://placehold.co/400x200/06B6D4/FFFFFF?text=Washing+Dishes" },
                { id: 45, front: 'داشتم به موسیقی گوش می‌دادم.', back_fa: 'I was listening to music.', back_en: '', text_to_speak: 'I was listening to music', image_url: "https://placehold.co/400x200/C026D3/FFFFFF?text=Music" },
                { id: 46, front: 'داشتم سالاد درست می‌کردم.', back_fa: 'I was making a salad.', back_en: '', text_to_speak: 'I was making a salad', image_url: "https://placehold.co/400x200/16A34A/FFFFFF?text=Making+Salad" },
            ];
            
            // --- STATE MANAGEMENT ---
            let state = {};
            let currentUserId = null;
            let currentReviewSession = { cards: [], currentIndex: 0, boxNumber: 0 };
            const NUM_BOXES = 5;
            const reviewIntervals = { 1: 1, 2: 3, 3: 7, 4: 14, 5: 30 };
            
            // --- VOICE SYNTHESIS ---
            let preferredVoice = null;

            function loadAndSetVoice() {
                const voices = window.speechSynthesis.getVoices();
                preferredVoice = voices.find(voice => voice.name === 'Google US English') || 
                                 voices.find(voice => voice.lang === 'en-US' && voice.localService);
                if (!preferredVoice) {
                    preferredVoice = voices.find(voice => voice.lang === 'en-US');
                }
            }
            
            window.speechSynthesis.onvoiceschanged = loadAndSetVoice;
            loadAndSetVoice();

            // --- DATE HELPERS ---
            function getTodayString() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            function calculateNextReviewDate(boxNumber) {
                const daysToAdd = reviewIntervals[boxNumber];
                const date = new Date();
                date.setDate(date.getDate() + daysToAdd);
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            }

            async function initializeState(userId) {
                console.log(`Initializing state for userId: ${userId}`);
                if (userId) {
                    const docRef = db.collection("leitner-data").doc(userId);
                    const doc = await docRef.get();
                    if (doc.exists) {
                        state = doc.data();
                        console.log('State loaded from Firebase:', state);
                    } else {
                        state = {};
                        console.log('No existing state found, initializing new state');
                    }
                } else {
                    const savedState = localStorage.getItem('leitnerStateWithDates');
                    state = savedState ? JSON.parse(savedState) : {};
                    console.log('State loaded from Local Storage:', state);
                }

                let stateUpdated = false;
                allCardsData.forEach(card => {
                    if (!state[card.id]) {
                        state[card.id] = { box: 1, nextReview: getTodayString() };
                        stateUpdated = true;
                    }
                });

                if (stateUpdated) {
                    await saveState(userId);
                    console.log('State updated and saved:', state);
                }
                updateUI();
            }

            async function saveState(userId) {
                console.log(`Saving state for userId: ${userId}`);
                if (userId) {
                    try {
                        await db.collection("leitner-data").doc(userId).set(state);
                        console.log('State saved to Firebase successfully');
                    } catch (error) {
                        console.error('Error saving state to Firebase:', error);
                    }
                } else {
                    localStorage.setItem('leitnerStateWithDates', JSON.stringify(state));
                    console.log('State saved to Local Storage');
                }
            }
            
            // --- AUTHENTICATION ---
            auth.onAuthStateChanged(user => {
                console.log('Auth state changed, user:', user);
                if (user) {
                    currentUserId = user.uid;
                    userProfileActions.classList.remove('hidden');
                    loginButton.classList.add('hidden');
                    userProfileActions.innerHTML = `
                        <div class="flex items-center gap-2">
                            <img src="${user.photoURL}" alt="Profile" class="w-8 h-8 rounded-full">
                            <span class="font-medium text-sm hidden sm:inline">${user.displayName}</span>
                        </div>
                        <button id="logout-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300">خروج</button>
                    `;
                    document.getElementById('logout-button').addEventListener('click', () => auth.signOut());
                    initializeState(currentUserId);
                    loginModal.classList.remove('show');
                    loginModal.classList.add('hidden');
                    attachAnswerButtonListeners();
                } else {
                    currentUserId = null;
                    userProfileActions.classList.add('hidden');
                    loginButton.classList.remove('hidden');
                    initializeState(null);
                    if (!sessionStorage.getItem('loginModalShown')) {
                        setTimeout(() => {
                            loginModal.classList.remove('hidden');
                            loginModal.classList.add('show');
                            sessionStorage.setItem('loginModalShown', 'true');
                        }, 2000);
                    }
                    attachAnswerButtonListeners();
                }
            });

            loginButton.addEventListener('click', () => {
                auth.signInWithPopup(provider).catch(error => {
                    console.error("Login failed:", error);
                    alert("خطا در ورود: " + error.message);
                });
            });

            modalLoginButton.addEventListener('click', () => {
                auth.signInWithPopup(provider).catch(error => {
                    console.error("Login failed:", error);
                    alert("خطا در ورود: " + error.message);
                });
            });

            closeModalBtn.addEventListener('click', () => {
                loginModal.classList.remove('show');
                loginModal.classList.add('hidden');
            });

            // --- UI FUNCTIONS ---
            function updateUI() {
                renderBoxes();
                attachAnswerButtonListeners();
            }

            function renderBoxes() {
                const container = document.getElementById('boxes-container');
                const todayNormalized = new Date(getTodayString());
                const todayString = getTodayString();
                container.innerHTML = '';
                for (let i = 1; i <= NUM_BOXES; i++) {
                    const cardsInBox = Object.values(state).filter(cardState => cardState.box === i);
                    const totalCardsInBox = cardsInBox.length;
                    const cardsDueInBox = cardsInBox.filter(cardState => cardState.nextReview <= todayString).length;

                    let timerHTML = '';
                    if (totalCardsInBox > 0) {
                        const earliestDateStr = cardsInBox.reduce((earliest, card) => card.nextReview < earliest ? card.nextReview : earliest, '9999-12-31');
                        const earliestDate = new Date(earliestDateStr);
                        const diffTime = earliestDate - todayNormalized;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                        if (diffDays <= 0) {
                            timerHTML = `<div class="mt-2"><p class="text-sm font-semibold text-blue-600">آماده مرور!</p></div>`;
                        } else {
                            timerHTML = `<div class="mt-2"><p class="text-sm text-gray-500">مرور بعدی: ${diffDays} روز دیگر</p></div>`;
                        }
                    } else {
                        timerHTML = `<div class="mt-2 h-5"></div>`;
                    }

                    const boxEl = document.createElement('div');
                    boxEl.className = `box border-2 border-gray-200 p-4 rounded-lg text-center cursor-pointer hover:border-blue-500 transition-all duration-300 bg-white`;
                    boxEl.innerHTML = `
                        <div>
                            <h3 class="font-bold text-lg sm:text-xl">جعبه ${i}</h3>
                            <div class="text-gray-600 mt-2 flex items-center justify-center gap-2">
                                <span class="box-count">${cardsDueInBox}</span>
                                <span class="text-sm sm:text-base">کارت آماده مرور</span>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">(مجموع: ${totalCardsInBox} کارت)</p>
                        </div>
                        ${timerHTML}
                    `;
                    boxEl.dataset.boxNumber = i;
                    container.appendChild(boxEl);
                }
            }
            
            function showCard(cardData) {
                const cardFront = document.getElementById('card-front');
                const cardBack = document.getElementById('card-back');
                const flashcard = document.querySelector('.flashcard');
                
                flashcard.classList.remove('is-flipped');
                cardFront.innerHTML = `<h3 class="text-xl sm:text-2xl font-bold p-4">${cardData.front}</h3>`;
                
                let backContent;
                if (cardData.back_en === '') {
                    backContent = `<p class="font-bold text-base sm:text-lg">${cardData.back_fa}</p>`;
                } else {
                    backContent = `
                        <p class="text-sm sm:text-base"><strong>معنی:</strong> ${cardData.back_fa}</p>
                        <p class="text-sm sm:text-base"><em><strong>مثال:</strong> ${cardData.back_en}</em></p>
                    `;
                }

                cardBack.innerHTML = `
                    <img src="${cardData.image_url}" alt="${cardData.front}" class="card-back-image" onerror="this.style.display='none'">
                    <div class="p-4 flex-grow flex flex-col justify-center items-center">
                        ${backContent}
                        <button class="pronunciation-button" data-text="${cardData.text_to_speak}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414z"/></svg>
                            <span>تلفظ</span>
                        </button>
                    </div>
                `;
            }

            // --- REVIEW LOGIC ---
            function startReview(boxNumber) {
                console.log(`Starting review for box ${boxNumber}`);
                const today = getTodayString();
                const cardIdsToReview = Object.keys(state).filter(id => 
                    state[id] && state[id].box === boxNumber && state[id].nextReview <= today
                );
                
                document.querySelectorAll('.box').forEach(b => b.classList.remove('active'));
                if (cardIdsToReview.length === 0) {
                    alert(`هیچ کارتی برای مرور در جعبه ${boxNumber} آماده نیست.`);
                    return;
                }
                
                document.querySelector(`[data-box-number='${boxNumber}']`).classList.add('active');
                currentReviewSession = { cards: shuffleArray(cardIdsToReview), currentIndex: 0, boxNumber: boxNumber };
                console.log('Current review session cards:', currentReviewSession.cards.length);
                
                document.getElementById('review-area').classList.remove('hidden');
                document.getElementById('no-review-message').classList.add('hidden');
                document.getElementById('answer-buttons').classList.remove('hidden');
                
                showNextCard();
            }

            function showNextCard() {
                console.log(`Showing card at index ${currentReviewSession.currentIndex}`);
                if (currentReviewSession.currentIndex >= currentReviewSession.cards.length) {
                    endReview();
                    return;
                }
                const cardId = currentReviewSession.cards[currentReviewSession.currentIndex];
                const cardData = allCardsData.find(c => c.id == cardId);
                
                document.getElementById('review-message').textContent = `جعبه ${currentReviewSession.boxNumber} - کارت ${currentReviewSession.currentIndex + 1} از ${currentReviewSession.cards.length}`;
                showCard(cardData);
            }

            function endReview() {
                document.getElementById('review-area').classList.add('hidden');
                document.getElementById('no-review-message').classList.remove('hidden');
                document.getElementById('no-review-message').innerHTML = `
                    <p class="text-lg sm:text-xl font-semibold text-green-600">مرور جعبه ${currentReviewSession.boxNumber} تمام شد!</p>
                    <p class="text-gray-500 mt-2">برای ادامه، یک جعبه دیگر را انتخاب کنید.</p>
                `;
                document.getElementById('answer-buttons').classList.add('hidden');
                document.querySelectorAll('.box').forEach(b => b.classList.remove('active'));
            }

            async function handleAnswer(isCorrect) {
                console.log(`Handling answer: ${isCorrect ? 'درست' : 'غلط'}, currentIndex: ${currentReviewSession.currentIndex}, total cards: ${currentReviewSession.cards.length}`);
                if (!currentReviewSession.cards || currentReviewSession.currentIndex >= currentReviewSession.cards.length) {
                    console.error('Invalid review session state');
                    return;
                }

                const cardId = currentReviewSession.cards[currentReviewSession.currentIndex];
                console.log(`Processing card ID: ${cardId}`);
                const cardState = state[cardId];

                if (isCorrect) {
                    const nextBox = Math.min(cardState.box + 1, NUM_BOXES);
                    state[cardId] = { box: nextBox, nextReview: calculateNextReviewDate(nextBox) };
                    console.log(`Card ${cardId} moved to box ${nextBox}`);
                } else {
                    state[cardId] = { box: 1, nextReview: calculateNextReviewDate(1) };
                    console.log(`Card ${cardId} moved back to box 1`);
                }

                await saveState(currentUserId);
                updateUI();
                
                currentReviewSession.currentIndex++;
                showNextCard();
            }

            // --- EVENT LISTENERS ---
            function attachAnswerButtonListeners() {
                if (listenersAttached) return;
                if (correctBtn && incorrectBtn) {
                    correctBtn.addEventListener('click', () => {
                        console.log('دکمه درست کلیک شد');
                        handleAnswer(true);
                    });
                    incorrectBtn.addEventListener('click', () => {
                        console.log('دکمه غلط کلیک شد');
                        handleAnswer(false);
                    });
                    listenersAttached = true;
                } else {
                    console.warn('دکمه‌های درست یا غلط در DOM یافت نشدند.');
                }
            }

            document.getElementById('boxes-container').addEventListener('click', function(event) {
                const box = event.target.closest('.box');
                if (box) startReview(parseInt(box.dataset.boxNumber));
            });

            document.getElementById('flashcard-display').addEventListener('click', function(event) {
                if (!event.target.closest('.pronunciation-button')) {
                    this.querySelector('.flashcard').classList.add('is-flipped');
                    document.getElementById('answer-buttons').classList.remove('hidden');
                }
            });

            document.body.addEventListener('click', function(event) {
                const pronunciationButton = event.target.closest('.pronunciation-button');
                if (pronunciationButton) {
                    event.stopPropagation();
                    const textToSpeak = pronunciationButton.dataset.text;
                    if (textToSpeak && 'speechSynthesis' in window) {
                        const utterance = new SpeechSynthesisUtterance(textToSpeak);
                        if (preferredVoice) {
                            utterance.voice = preferredVoice;
                        }
                        utterance.lang = 'en-US';
                        utterance.rate = 0.9;
                        window.speechSynthesis.speak(utterance);
                    }
                }
            });

            document.getElementById('reset-progress').addEventListener('click', async function() {
                if (confirm('آیا مطمئن هستید؟ تمام پیشرفت شما پاک خواهد شد و همه کارت‌ها به جعبه ۱ برمی‌گردند.')) {
                    state = {};
                    allCardsData.forEach(card => {
                        state[card.id] = { box: 1, nextReview: getTodayString() };
                    });
                    await saveState(currentUserId);
                    location.reload();
                }
            });

            // --- HELPERS ---
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            // اتصال اولیه شنونده‌ها
            attachAnswerButtonListeners();
        });
    </script>
</body>
</html>
