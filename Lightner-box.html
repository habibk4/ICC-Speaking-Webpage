<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>جعبه لایتنر دوره ICC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .main-container {
            flex-grow: 1;
        }
        .flashcard-container { perspective: 1000px; height: 250px; width: 100%; max-width: 500px; }
        .flashcard { position: relative; width: 100%; height: 100%; transition: transform 0.7s; transform-style: preserve-3d; cursor: pointer; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; }
        .card-front { background-color: #ffffff; border: 1px solid #e2e8f0; }
        .card-back { background-color: #f8fafc; border: 1px solid #e2e8f0; transform: rotateY(180deg); font-size: 0.9em; line-height: 1.6; }
        .pronunciation-button { display: inline-flex; align-items: center; gap: 0.5rem; margin-top: 0.75rem; padding: 0.5rem 1rem; background-color: #e0f2fe; color: #0c4a6e; border-radius: 9999px; font-weight: 500; text-decoration: none; transition: background-color 0.2s; border: none; cursor: pointer; }
        .pronunciation-button:hover { background-color: #bae6fd; }
        .box-count { background-color: #1d4ed8; color: white; border-radius: 50%; width: 28px; height: 28px; display: inline-flex; justify-content: center; align-items: center; font-weight: bold; }
        .box.active { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); }
        .box { display: flex; flex-direction: column; justify-content: space-between; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="main-container container mx-auto max-w-5xl p-4 sm:p-8">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-xl sm:text-2xl font-bold text-gray-800">جعبه لایتنر دوره ICC</h1>
            <div id="auth-container">
                <!-- Auth state will be rendered here -->
            </div>
        </header>

        <div id="app-container" class="bg-white rounded-2xl shadow-xl p-6 sm:p-10">
            <!-- Login View -->
            <div id="login-view" class="text-center py-16">
                <h2 class="text-2xl font-bold mb-4">به جعبه لایتنر خود خوش آمدید!</h2>
                <p class="text-gray-600 mb-8">برای ذخیره و همگام‌سازی پیشرفت خود، وارد شوید.</p>
                <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg inline-flex items-center gap-3 transition">
                    <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C39.712,34.464,44,28.756,44,20C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                    <span>ورود با گوگل</span>
                </button>
                <!-- Error message will be appended here by JS -->
            </div>

            <!-- App View -->
            <div id="app-view" class="hidden">
                 <!-- Boxes Display -->
                <div id="boxes-container" class="grid grid-cols-2 sm:grid-cols-5 gap-4 mb-8"></div>

                <!-- Review Area -->
                <div id="review-area" class="w-full mx-auto text-center hidden">
                    <p id="review-message" class="text-lg font-semibold mb-4"></p>
                    <div id="flashcard-display" class="flashcard-container mx-auto mb-6">
                        <div class="flashcard">
                            <div id="card-front" class="card-face card-front"></div>
                            <div id="card-back" class="card-face card-back"></div>
                        </div>
                    </div>
                    <div id="answer-buttons" class="flex justify-center gap-4 hidden">
                        <button id="correct-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg">درست</button>
                        <button id="incorrect-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-8 rounded-lg">غلط</button>
                    </div>
                </div>
                 <div id="no-review-message" class="text-center py-10 px-6 bg-gray-50 rounded-lg">
                    <p class="text-xl font-semibold text-gray-700">برای شروع، یک جعبه را انتخاب کنید.</p>
                </div>
                
                <div class="text-center mt-8">
                    <button id="reset-progress" class="text-sm text-gray-400 hover:text-red-500 hover:underline">شروع مجدد و پاک کردن تمام پیشرفت</button>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="text-center p-4 mt-auto text-gray-500 text-sm">
        <p>طراحی و توسعه حبیب کمایی</p>
        <p>Habibkamaie@gmail.com</p>
    </footer>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- IMPORTANT: Firebase Configuration ---
        // This object is a placeholder. If you are running this code outside of the
        // intended environment, you MUST replace these values with your own
        // Firebase project's configuration from the Firebase console.
        // The app will automatically use the correct config (__firebase_config) when run in the proper environment.
        const firebaseConfigPlaceholder = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfigPlaceholder;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- UI Elements ---
        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');
        const authContainer = document.getElementById('auth-container');
        const loginBtn = document.getElementById('login-btn');

        // --- DATA ---
        const allCardsData = [
                { id: 1, front: 'سه سوته / In a jiffy', back_fa: 'خیلی سریع.', back_en: "I'll be back in a jiffy, just wait here.", text_to_speak: "In a jiffy" },
                { id: 2, front: 'دو دلم / On the fence', back_fa: 'مردد بودن.', back_en: "I'm on the fence about accepting the new job offer.", text_to_speak: "On the fence" },
                { id: 3, front: 'Never in a million years', back_fa: 'هرگز، عمراً.', back_en: "Never in a million years would I have guessed the surprise.", text_to_speak: "Never in a million years" },
                { id: 4, front: 'Cost an arm and a leg', back_fa: 'خیلی گران بودن.', back_en: "That new designer handbag cost her an arm and a leg.", text_to_speak: "Cost an arm and a leg" },
                { id: 5, front: 'It is what it is', back_fa: 'شرایط همین است (کاری نمی‌توان کرد).', back_en: "We can't change the past. It is what it is.", text_to_speak: "It is what it is" },
                { id: 6, front: 'Take it or leave it', back_fa: 'پیشنهاد نهایی (یا قبول کن یا رد کن).', back_en: "This is my last offer. Take it or leave it.", text_to_speak: "Take it or leave it" },
                { id: 7, front: 'Take a hike', back_fa: 'برو گمشو (بی‌ادبانه).', back_en: "He told his noisy neighbors to take a hike.", text_to_speak: "Take a hike" },
                { id: 8, front: 'Backbiting', back_fa: 'پشت سر کسی بدگویی کردن.', back_en: "I hate office politics and backbiting.", text_to_speak: "Backbiting" },
                { id: 9, front: 'Catch red-handed', back_fa: 'مچ کسی را حین ارتکاب جرم گرفتن.', back_en: "The manager caught the employee red-handed stealing office supplies.", text_to_speak: "Catch red-handed" },
                { id: 10, front: "Don't count your chickens before they hatch", back_fa: 'جوجه را آخر پاییز می‌شمارند.', back_en: "You may get the job, but don't count your chickens before they hatch.", text_to_speak: "Don't count your chickens before they hatch" },
                { id: 11, front: "A friend in need is a friend indeed", back_fa: 'دوست واقعی در سختی‌ها شناخته می‌شود.', back_en: "She helped me when I was broke. A friend in need is a friend indeed.", text_to_speak: "A friend in need is a friend indeed" },
                { id: 12, front: 'The milk boiled over', back_fa: 'شیر سر رفت.', back_en: "I was on the phone and the milk boiled over.", text_to_speak: "The milk boiled over" },
                { id: 13, front: 'The power went out', back_fa: 'برق رفت.', back_en: "The power went out, and everything went dark.", text_to_speak: "The power went out" },
                { id: 14, front: 'Its battery died', back_fa: 'باتری‌اش تمام شد.', back_en: "My phone's battery died during the important call.", text_to_speak: "Its battery died" },
                { id: 15, front: 'Tapped me on the shoulder', back_fa: 'به شانه‌ام زد.', back_en: "A stranger tapped me on the shoulder to ask for directions.", text_to_speak: "Tapped me on the shoulder" },
                { id: 16, front: 'Fell asleep', back_fa: 'خوابم برد.', back_en: "After a long day, I fell asleep immediately.", text_to_speak: "Fell asleep" },
                { id: 17, front: 'Cut my finger', back_fa: 'انگشتم را بریدم.', back_en: "Be careful with that knife, I just cut my finger.", text_to_speak: "Cut my finger" },
                { id: 18, front: 'Sprained my ankle', back_fa: 'مچ پایم پیچ خورد.', back_en: "I slipped on the ice and sprained my ankle.", text_to_speak: "Sprained my ankle" },
                { id: 19, front: 'To haggle', back_fa: 'چانه زدن.', back_en: "In many markets, you are expected to haggle over the price.", text_to_speak: "To haggle" },
                { id: 20, front: 'Passed out', back_fa: 'غش کرد، از هوش رفت.', back_en: "He passed out from the heat.", text_to_speak: "Passed out" },
                { id: 21, front: 'My car broke down', back_fa: 'ماشینم خراب شد.', back_en: "My car broke down in the middle of the highway.", text_to_speak: "My car broke down" },
                { id: 22, front: 'I had an accident', back_fa: 'تصادف کردم.', back_en: "I had an accident on my way here, so I'm a bit late.", text_to_speak: "I had an accident" },
                { id: 23, front: 'Someone knocked at the door', back_fa: 'یکی در زد.', back_en: "I was watching a movie when someone knocked at the door.", text_to_speak: "Someone knocked at the door" },
                { id: 24, front: 'Dust', back_fa: 'اسم: گرد و خاک. فعل: گردگیری کردن.', back_en: "I need to dust the shelves before the guests arrive.", text_to_speak: "Dust" },
                { id: 25, front: 'Cockroach', back_fa: 'سوسک.', back_en: "He screamed when he saw a cockroach in the bathroom.", text_to_speak: "Cockroach" },
                { id: 26, front: 'Cheat', back_fa: 'تقلب کردن.', back_en: "The teacher warned the students not to cheat on the exam.", text_to_speak: "Cheat" },
                { id: 27, front: 'Whispering', back_fa: 'پچ‌پچ کردن.', back_en: "They were whispering so no one else could hear.", text_to_speak: "Whispering" },
                { id: 28, front: 'Shouting', back_fa: 'داد زدن.', back_en: "Please stop shouting, I'm right here.", text_to_speak: "Shouting" },
                { id: 29, front: 'Yawning', back_fa: 'خمیازه کشیدن.', back_en: "His constant yawning showed how bored he was.", text_to_speak: "Yawning" },
                { id: 30, front: 'Ogling', back_fa: 'چشم‌چرانی کردن، دید زدن.', back_en: "The man was rudely ogling the people at the next table.", text_to_speak: "Ogling" },
                { id: 31, front: 'Whistling', back_fa: 'سوت زدن.', back_en: "He walked down the street, whistling a cheerful tune.", text_to_speak: "Whistling" },
        ];
        
        // --- STATE MANAGEMENT ---
        let state = {};
        let currentUserId = null;
        let currentReviewSession = { cards: [], currentIndex: 0, boxNumber: 0 };
        const NUM_BOXES = 5;
        const reviewIntervals = { 1: 1, 2: 3, 3: 7, 4: 14, 5: 30 };

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, user => {
            if (user) {
                // User is signed in
                currentUserId = user.uid;
                loginView.classList.add('hidden');
                appView.classList.remove('hidden');
                renderAuthenticatedUI(user);
                initializeState(currentUserId);
            } else {
                // User is signed out
                currentUserId = null;
                loginView.classList.remove('hidden');
                appView.classList.add('hidden');
                renderLoggedOutUI();
            }
        });

        loginBtn.addEventListener('click', async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                if (error.code === 'auth/unauthorized-domain') {
                    showAuthError();
                } else {
                    console.error("Login failed:", error);
                }
            }
        });

        function showAuthError() {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mt-4 rounded-lg text-right';
            errorDiv.innerHTML = `
                <p class="font-bold">خطای دسترسی (Unauthorized Domain)</p>
                <p class="text-sm">این دامنه برای پروژه Firebase شما مجاز نیست. برای حل مشکل:</p>
                <ol class="list-decimal list-inside text-sm mt-2">
                    <li>به <a href="https://console.firebase.google.com/" target="_blank" class="underline font-semibold">کنسول Firebase</a> بروید.</li>
                    <li>پروژه خود را انتخاب کنید.</li>
                    <li>به بخش Authentication -> Settings -> Authorized domains بروید.</li>
                    <li>روی "Add domain" کلیک کرده و دامنه زیر را اضافه کنید:</li>
                    <li class="font-mono bg-gray-200 p-1 rounded my-1 text-left" dir="ltr">${window.location.hostname}</li>
                </ol>
            `;
            const existingError = loginView.querySelector('.bg-red-100');
            if (existingError) {
                existingError.remove();
            }
            loginView.appendChild(errorDiv);
        }

        function userLogout() {
            signOut(auth).catch((error) => console.error("Logout failed:", error));
        }

        // --- FIRESTORE DATA HANDLING ---
        async function initializeState(userId) {
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/leitner-data`, "state");
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                state = docSnap.data();
            } else {
                // No saved state, create a new one
                state = {};
                allCardsData.forEach(card => {
                    state[card.id] = { box: 1, nextReview: getTodayString() };
                });
                await saveState(userId);
            }
            updateUI();
        }

        async function saveState(userId) {
            if (!userId) return;
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/leitner-data`, "state");
            await setDoc(docRef, state);
        }

        // --- UI RENDERING ---
        function renderAuthenticatedUI(user) {
            authContainer.innerHTML = `
                <div class="flex items-center gap-4">
                    <span class="text-sm font-semibold">${user.displayName}</span>
                    <img src="${user.photoURL}" alt="User Photo" class="w-10 h-10 rounded-full">
                    <button id="logout-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">خروج</button>
                </div>
            `;
            document.getElementById('logout-btn').addEventListener('click', userLogout);
        }

        function renderLoggedOutUI() {
            authContainer.innerHTML = ''; // Clear user info
        }

        function renderBoxes() {
            const container = document.getElementById('boxes-container');
            const todayNormalized = new Date(getTodayString());
            const todayString = getTodayString();
            container.innerHTML = '';
            for (let i = 1; i <= NUM_BOXES; i++) {
                const cardsInBox = Object.values(state).filter(cardState => cardState.box === i);
                const totalCardsInBox = cardsInBox.length;
                const cardsDueInBox = cardsInBox.filter(cardState => cardState.nextReview <= todayString).length;

                let timerHTML = '';
                if (totalCardsInBox > 0) {
                    const earliestDateStr = cardsInBox.reduce((earliest, card) => card.nextReview < earliest ? card.nextReview : earliest, '9999-12-31');
                    const earliestDate = new Date(earliestDateStr);
                    const diffTime = earliestDate - todayNormalized;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays <= 0) {
                        timerHTML = `<div class="mt-2"><p class="text-sm font-semibold text-blue-600">آماده مرور!</p></div>`;
                    } else {
                        timerHTML = `<div class="mt-2"><p class="text-sm text-gray-500">مرور بعدی: ${diffDays} روز دیگر</p></div>`;
                    }
                } else {
                    timerHTML = `<div class="mt-2 h-5"></div>`;
                }

                const boxEl = document.createElement('div');
                boxEl.className = `box border-2 border-gray-300 p-4 rounded-lg text-center cursor-pointer hover:border-blue-500 transition`;
                boxEl.innerHTML = `
                    <div>
                        <h3 class="font-bold text-lg">جعبه ${i}</h3>
                        <div class="text-gray-600 mt-2 flex items-center justify-center gap-2">
                            <span class="box-count">${cardsDueInBox}</span>
                            <span>کارت آماده مرور</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">(مجموع: ${totalCardsInBox} کارت)</p>
                    </div>
                    ${timerHTML}
                `;
                boxEl.dataset.boxNumber = i;
                container.appendChild(boxEl);
            }
        }

        function showCard(cardData) {
            const cardFront = document.getElementById('card-front');
            const cardBack = document.getElementById('card-back');
            const flashcard = document.querySelector('.flashcard');
            
            flashcard.classList.remove('is-flipped');

            cardFront.innerHTML = `<h3 class="text-2xl font-bold">${cardData.front}</h3>`;
            cardBack.innerHTML = `
                <p><strong>معنی:</strong> ${cardData.back_fa}</p>
                <p><em><strong>مثال:</strong> ${cardData.back_en}</em></p>
                <button class="pronunciation-button" data-text="${cardData.text_to_speak}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414z"/></svg>
                    <span>تلفظ</span>
                </button>
            `;
        }

        // --- REVIEW LOGIC ---
        function startReview(boxNumber) {
            const today = getTodayString();
            const cardIdsToReview = Object.keys(state).filter(id => 
                state[id].box === boxNumber && state[id].nextReview <= today
            );
            
            document.querySelectorAll('.box').forEach(b => b.classList.remove('active'));

            if (cardIdsToReview.length === 0) {
                alert(`هیچ کارتی برای مرور در جعبه ${boxNumber} آماده نیست.`);
                return;
            }
            
            document.querySelector(`[data-box-number='${boxNumber}']`).classList.add('active');

            currentReviewSession = {
                cards: shuffleArray(cardIdsToReview),
                currentIndex: 0,
                boxNumber: boxNumber
            };
            
            document.getElementById('review-area').classList.remove('hidden');
            document.getElementById('no-review-message').classList.add('hidden');
            document.getElementById('answer-buttons').classList.add('hidden');
            
            showNextCard();
        }

        function showNextCard() {
            if (currentReviewSession.currentIndex >= currentReviewSession.cards.length) {
                endReview();
                return;
            }

            const cardId = currentReviewSession.cards[currentReviewSession.currentIndex];
            const cardData = allCardsData.find(c => c.id == cardId);
            
            document.getElementById('review-message').textContent = `جعبه ${currentReviewSession.boxNumber} - کارت ${currentReviewSession.currentIndex + 1} از ${currentReviewSession.cards.length}`;
            showCard(cardData);
        }

        function endReview() {
            document.getElementById('review-area').classList.add('hidden');
            document.getElementById('no-review-message').classList.remove('hidden');
            document.getElementById('no-review-message').innerHTML = `
                <p class="text-xl font-semibold text-green-700">مرور جعبه ${currentReviewSession.boxNumber} تمام شد!</p>
                <p class="text-gray-500 mt-2">برای ادامه، یک جعبه دیگر را انتخاب کنید.</p>
            `;
            document.querySelectorAll('.box').forEach(b => b.classList.remove('active'));
        }

        async function handleAnswer(isCorrect) {
            const cardId = currentReviewSession.cards[currentReviewSession.currentIndex];
            const cardState = state[cardId];

            if (isCorrect) {
                const nextBox = Math.min(cardState.box + 1, NUM_BOXES);
                state[cardId] = { box: nextBox, nextReview: calculateNextReviewDate(nextBox) };
            } else {
                state[cardId] = { box: 1, nextReview: calculateNextReviewDate(1) };
            }

            await saveState(currentUserId);
            updateUI();
            
            currentReviewSession.currentIndex++;
            showNextCard();
        }

        // --- EVENT LISTENERS ---
        document.getElementById('boxes-container').addEventListener('click', function(event) {
            const box = event.target.closest('.box');
            if (box) startReview(parseInt(box.dataset.boxNumber));
        });

        document.getElementById('flashcard-display').addEventListener('click', function(event) {
            if (!event.target.closest('.pronunciation-button')) {
                this.querySelector('.flashcard').classList.add('is-flipped');
                document.getElementById('answer-buttons').classList.remove('hidden');
            }
        });

        document.getElementById('correct-btn').addEventListener('click', () => handleAnswer(true));
        document.getElementById('incorrect-btn').addEventListener('click', () => handleAnswer(false));
        
        document.body.addEventListener('click', function(event) {
            const pronunciationButton = event.target.closest('.pronunciation-button');
            if (pronunciationButton) {
                event.stopPropagation();
                const textToSpeak = pronunciationButton.dataset.text;
                if (textToSpeak && 'speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(textToSpeak);
                    utterance.lang = 'en-US';
                    utterance.rate = 0.9;
                    speechSynthesis.speak(utterance);
                }
            }
        });

        document.getElementById('reset-progress').addEventListener('click', async function() {
            if (confirm('آیا مطمئن هستید؟ تمام پیشرفت شما پاک خواهد شد و همه کارت‌ها به جعبه ۱ برمی‌گردند.')) {
                allCardsData.forEach(card => {
                    state[card.id] = { box: 1, nextReview: getTodayString() };
                });
                await saveState(currentUserId);
                location.reload();
            }
        });

        // --- HELPERS ---
        function getTodayString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function calculateNextReviewDate(boxNumber) {
            const daysToAdd = reviewIntervals[boxNumber];
            const date = new Date();
            date.setDate(date.getDate() + daysToAdd);
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

    </script>
</body>
</html>
