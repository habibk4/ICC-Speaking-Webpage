<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙ…Ø±ÛŒÙ† Ø²Ø¨Ø§Ù† Ø¯ÙˆØ±Ù‡ ICC - Ø¬Ù„Ø³Ù‡ Û³Û¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f8f9fa; 
        }
        .main-container {
            flex-grow: 1;
        }
        .flashcard-container { perspective: 1000px; height: 320px; width: 100%; max-width: 600px; }
        .flashcard { position: relative; width: 100%; height: 100%; transition: transform 0.7s; transform-style: preserve-3d; cursor: pointer; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 8px 24px rgba(0,0,0,0.1); text-align: center; border: 1px solid #e2e8f0; }
        .card-front { background-color: #ffffff; }
        .card-back { background-color: #f8fafc; transform: rotateY(180deg); }
        .pronunciation-button { display: inline-flex; align-items: center; gap: 0.5rem; margin-top: 1rem; padding: 0.5rem 1rem; background-color: #e0f2fe; color: #0c4a6e; border-radius: 9999px; font-weight: 500; transition: all 0.2s; border: none; cursor: pointer; }
        .pronunciation-button:hover { background-color: #bae6fd; transform: scale(1.05); }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }
        .menu-card {
            transition: all 0.3s ease-in-out;
        }
        .menu-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
       
        .action-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .action-buttons .btn {
            padding: 0.75rem 2rem;
            font-weight: bold;
            border-radius: 0.75rem;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
        }
        .action-buttons .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-correct {
            background-color: #10b981; /* green-500 */
            color: white;
        }
        .btn-incorrect {
            background-color: #ef4444; /* red-500 */
            color: white;
        }
        
        /* New Infographic Styles from session-36-info */
        .lesson-content .card {
            background-color: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .lesson-content .chart-container {
            position: relative;
            width: 100%;
            max-width: 150px;
            margin-left: auto;
            margin-right: auto;
            height: 150px;
        }
        .lesson-content .correct { color: #06D6A0; }
        .lesson-content .incorrect { color: #EF4444; }
        .lesson-content .proverb-banner {
            background: linear-gradient(135deg, #06D6A0 0%, #118AB2 100%);
            color: white;
            padding: 2rem;
            border-radius: 1.5rem;
            margin-top: 3rem;
            text-align: center;
            box-shadow: 0 10px 20px -5px rgba(6, 214, 160, 0.4);
        }
        .highlight {
            color: #118AB2;
            font-weight: bold;
            position: relative;
            cursor: pointer;
        }
        .highlight .tooltip-text {
            visibility: hidden;
            width: 150px;
            background-color: #073B4C;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -75px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .highlight:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        #story-content-container p {
            line-height: 2;
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            color: #334155;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="main-container container mx-auto max-w-6xl p-4 sm:p-8">
        <header class="text-center mb-8 sm:mb-12 fade-in">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-800">ØªÙ…Ø±ÛŒÙ† Ø²Ø¨Ø§Ù† Ø¯ÙˆØ±Ù‡ ICC - Ø¬Ù„Ø³Ù‡ Û³Û¶</h1>
            <p id="header-subtitle" class="text-slate-500 mt-2">ÛŒÚ© Ø¨Ø®Ø´ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ ØªÙ…Ø±ÛŒÙ† Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>
        </header>

        <!-- Main Menu View -->
        <div id="main-menu-view" class="fade-in" style="animation-delay: 0.2s;">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <!-- Lesson 36 Card -->
                <div id="start-lesson36-btn" class="menu-card bg-white rounded-2xl shadow-lg p-8 text-center cursor-pointer">
                    <div class="text-5xl text-yellow-400 mb-4">âœ¨</div>
                    <h2 class="text-2xl font-bold text-slate-800">Ø¯Ø±Ø³ Ø¬Ù„Ø³Ù‡ Û³Û¶</h2>
                    <p class="text-slate-500 mt-2">Ú¯Ø±Ø§Ù…Ø± Ø²Ù…Ø§Ù† Ø­Ø§Ù„ Ú©Ø§Ù…Ù„ Ùˆ Ù†Ú©Ø§Øª Ø¯ÛŒÚ¯Ø±.</p>
                </div>
                <!-- Story Card -->
                <div id="start-story-btn" class="menu-card bg-white rounded-2xl shadow-lg p-8 text-center cursor-pointer">
                    <div class="text-5xl text-yellow-400 mb-4">ğŸ“–</div>
                    <h2 class="text-2xl font-bold text-slate-800">Ø¯Ø§Ø³ØªØ§Ù†</h2>
                    <p class="text-slate-500 mt-2">Ù…Ø±ÙˆØ± Ú¯Ø±Ø§Ù…Ø± Ùˆ Ú©Ù„Ù…Ø§Øª Ø¯Ø± Ù‚Ø§Ù„Ø¨ ÛŒÚ© Ø¯Ø§Ø³ØªØ§Ù† Ø¬Ø°Ø§Ø¨.</p>
                </div>
                <!-- Vocab Card -->
                <div id="start-vocab-btn" class="menu-card bg-white rounded-2xl shadow-lg p-8 text-center cursor-pointer">
                    <div class="text-5xl text-green-400 mb-4">ğŸ”¤</div>
                    <h2 class="text-2xl font-bold text-slate-800">ØªÙ…Ø±ÛŒÙ† Ú©Ù„Ù…Ø§Øª Ùˆ Ø§ØµØ·Ù„Ø§Ø­Ø§Øª</h2>
                    <p class="text-slate-500 mt-2">ÙˆØ§Ú˜Ú¯Ø§Ù†ØŒ Ø§ØµØ·Ù„Ø§Ø­Ø§Øª Ùˆ Ø¹Ø¨Ø§Ø±Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ Ø±Ø§ Ù…Ø±ÙˆØ± Ú©Ù†ÛŒØ¯.</p>
                </div>
                <!-- Grammar Card -->
                <div id="start-grammar-btn" class="menu-card bg-white rounded-2xl shadow-lg p-8 text-center cursor-pointer">
                    <div class="text-5xl text-blue-400 mb-4">ğŸ“</div>
                    <h2 class="text-2xl font-bold text-slate-800">ØªÙ…Ø±ÛŒÙ† Ú¯Ø±Ø§Ù…Ø±</h2>
                    <p class="text-slate-500 mt-2">Ø³Ø§Ø®ØªØ§Ø±Ù‡Ø§ÛŒ Ú¯Ø±Ø§Ù…Ø±ÛŒ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ØªÙ…Ø±ÛŒÙ† Ú©Ù†ÛŒØ¯.</p>
                </div>
            </div>
        </div>

        <!-- Practice View (For Flashcards) -->
        <div id="practice-view" class="hidden">
            <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-10">
                <div id="review-area" class="w-full mx-auto text-center">
                    <div id="flashcard-display" class="flashcard-container mx-auto mb-8">
                        <div class="flashcard">
                            <div id="card-front" class="card-face card-front"></div>
                            <div id="card-back" class="card-face card-back p-0"></div>
                        </div>
                    </div>
                    <div id="interactive-buttons" class="action-buttons hidden">
                        <button id="did-not-know-btn" class="btn btn-incorrect">Ø¨Ù„Ø¯ Ù†Ø¨ÙˆØ¯Ù…</button>
                        <button id="knew-it-btn" class="btn btn-correct">Ø¨Ù„Ø¯ Ø¨ÙˆØ¯Ù…</button>
                    </div>
                    <div class="flex justify-center items-center gap-4 mt-8 border-t border-slate-200 pt-6">
                        <button id="prev-card-btn" class="px-6 py-3 text-sm font-bold bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg transition">Ù‚Ø¨Ù„ÛŒ</button>
                        <p id="card-counter" class="text-slate-500 font-medium text-sm w-20 text-center"></p>
                        <button id="next-card-btn" class="px-6 py-3 text-sm font-bold bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg transition">Ø¨Ø¹Ø¯ÛŒ</button>
                    </div>
                </div>
                <div class="text-center mt-8 border-t border-slate-200 pt-6">
                    <button class="back-to-menu-btn text-sm text-blue-600 hover:underline font-semibold">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ</button>
                </div>
            </div>
        </div>

        <!-- Lesson View -->
        <div id="lesson-view" class="hidden">
            <div id="lesson-content-container" class="bg-gray-50 rounded-2xl shadow-xl p-8 sm:p-12 lesson-content">
                <!-- Lesson content will be injected here by JS -->
                <div class="text-center mt-10 border-t border-slate-200 pt-6">
                    <button class="back-to-menu-btn text-sm text-blue-600 hover:underline font-semibold">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ</button>
                </div>
            </div>
        </div>

        <!-- Story View -->
        <div id="story-view" class="hidden">
            <div id="story-content-container" class="bg-white rounded-2xl shadow-xl p-8 sm:p-12 lesson-content" dir="ltr">
                <!-- Story content will be injected here by JS -->
                <div class="text-center mt-10 border-t border-slate-200 pt-6" dir="rtl">
                    <button class="back-to-menu-btn text-sm text-blue-600 hover:underline font-semibold">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ</button>
                </div>
            </div>
        </div>

        <!-- Results View -->
        <div id="results-view" class="hidden">
             <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-10 text-center">
                <h2 class="text-2xl sm:text-3xl font-bold text-slate-800 mb-4">Ù†ØªØ§ÛŒØ¬ ØªÙ…Ø±ÛŒÙ†</h2>
                <div id="results-stats" class="text-lg text-slate-700 mb-6"></div>
                <button id="save-results-btn" class="px-6 py-3 text-sm font-bold bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition mb-4">Ø°Ø®ÛŒØ±Ù‡ Ù†ØªØ§ÛŒØ¬</button>
                <div id="save-message" class="text-sm font-medium text-green-700"></div>
                <div class="text-center mt-8 border-t border-slate-200 pt-6">
                    <button class="back-to-menu-btn text-sm text-blue-600 hover:underline font-semibold">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ</button>
                </div>
            </div>
        </div>
        
    </div>
    
    <footer class="text-center p-4 mt-auto text-slate-500 text-sm">
        <p>Ø·Ø±Ø§Ø­ÛŒ Ùˆ ØªÙˆØ³Ø¹Ù‡ Ø­Ø¨ÛŒØ¨ Ú©Ù…Ø§ÛŒÛŒ</p>
        <p>Habibkamaie@gmail.com</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async function () {
            // --- Firebase Setup ---
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
            
            let db, auth, userId;
            let firebaseInitialized = false;

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                firebaseInitialized = true;
                console.log("Firebase initialized successfully.");

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User authenticated with UID:", userId);
                    } else {
                        console.log("User signed out.");
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
            }

            // --- UI Elements ---
            const mainMenuView = document.getElementById('main-menu-view');
            const practiceView = document.getElementById('practice-view');
            const lessonView = document.getElementById('lesson-view');
            const storyView = document.getElementById('story-view');
            const resultsView = document.getElementById('results-view');
            
            const startLesson36Btn = document.getElementById('start-lesson36-btn');
            const startStoryBtn = document.getElementById('start-story-btn');
            const startVocabBtn = document.getElementById('start-vocab-btn');
            const startGrammarBtn = document.getElementById('start-grammar-btn');

            const backToMenuBtns = document.querySelectorAll('.back-to-menu-btn');
            const headerSubtitle = document.getElementById('header-subtitle');
            const cardCounter = document.getElementById('card-counter');
            const prevCardBtn = document.getElementById('prev-card-btn');
            const nextCardBtn = document.getElementById('next-card-btn');
            const lessonContentContainer = document.getElementById('lesson-content-container');
            const storyContentContainer = document.getElementById('story-content-container');
            
            const interactiveButtons = document.getElementById('interactive-buttons');
            const knewItBtn = document.getElementById('knew-it-btn');
            const didNotKnowBtn = document.getElementById('did-not-know-btn');
            const flashcardDisplay = document.getElementById('flashcard-display');
            const resultsStats = document.getElementById('results-stats');
            const saveResultsBtn = document.getElementById('save-results-btn');
            const saveMessage = document.getElementById('save-message');

            // --- DATA ---
            const lesson36Content = [
                {
                    type: 'raw_html',
                    html: `
                        <div class="container mx-auto p-0">
                             <header class="text-center mb-12">
                                <h1 class="text-4xl md:text-5xl font-black text-[#073B4C] mb-2">ğŸ“š Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø¬Ø§Ù…Ø¹ Ø²Ù…Ø§Ù† Ø­Ø§Ù„ Ú©Ø§Ù…Ù„</h1>
                                <p class="text-lg text-[#118AB2] font-bold">(ØªÙ…Ø§Ù… Ù†Ú©Ø§ØªÛŒ Ú©Ù‡ Ø¨Ø±Ø§ÛŒ Ù…Ø³Ù„Ø· Ø´Ø¯Ù† Ù†ÛŒØ§Ø² Ø¯Ø§Ø±ÛŒ!)</p>
                            </header>
                            
                            <main class="space-y-16">
                                <!-- Ø¨Ø®Ø´ Ø­Ø§Ù„ Ú©Ø§Ù…Ù„ -->
                                <section>
                                    <div class="text-center p-8 mb-8 bg-gradient-to-r from-[#FF6B6B] to-[#FFD166] text-white rounded-xl shadow-lg">
                                        <h2 class="text-3xl font-bold">Ø¨Ø®Ø´ Ø§ÙˆÙ„: Ø²Ù…Ø§Ù† Ø­Ø§Ù„ Ú©Ø§Ù…Ù„ (Present Perfect)</h2>
                                    </div>
                                    <div class="space-y-8">
                                        <!-- Ú©Ø§Ø±Ø¨Ø±Ø¯ Ùˆ Ø³Ø§Ø®ØªØ§Ø± -->
                                        <div class="card p-6">
                                            <h3 class="text-2xl font-bold text-[#FF6B6B] mb-4 text-center">ğŸ¯ Ú©Ø§Ø±Ø¨Ø±Ø¯ Ø§ØµÙ„ÛŒ Ùˆ Ø³Ø§Ø®ØªØ§Ø±</h3>
                                            <div class="grid md:grid-cols-2 gap-8 items-center">
                                                <p class="text-gray-600 leading-loose">Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¯Ø± Ú¯Ø°Ø´ØªÙ‡ Ø´Ø±ÙˆØ¹ Ø´Ø¯Ù‡ Ùˆ Ø§Ø«Ø±Ø´Ø§Ù† ØªØ§ Ø§Ù„Ø§Ù† Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ø§Ø±Ø¯ØŒ ÛŒØ§ Ø¨Ù‡ ØªØ§Ø²Ú¯ÛŒ ØªÙ…Ø§Ù… Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯ Ùˆ Ù†ØªÛŒØ¬Ù‡â€ŒØ´Ø§Ù† Ù…Ù‡Ù… Ø§Ø³Øª. Ø§ÛŒÙ† Â«ØªØ§ Ø§Ù„Ø§Ù†Â» Ú©Ù„ÛŒØ¯ Ù…Ø§Ø¬Ø±Ø§Ø³Øª.</p>
                                                <div class="mt-4 pt-4 border-t-2 md:border-t-0 md:border-r-2 border-dashed pr-0 md:pr-8">
                                                    <p class="font-bold text-[#118AB2] text-center">Ø³Ø§Ø®ØªØ§Ø±:</p>
                                                    <p class="bg-gray-100 p-3 mt-2 rounded-lg font-mono text-left dir-ltr text-sm">Subject + <span class="text-[#FF6B6B] font-bold">have/has</span> + <span class="text-[#FF6B6B] font-bold">Past Participle</span></p>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- For vs Since -->
                                        <div class="card p-6">
                                            <h3 class="text-2xl font-bold text-[#FF6B6B] mb-4 text-center">Ø¨ÛŒØ§Ù† Ù…Ø¯Øª Ø²Ù…Ø§Ù†: For Ùˆ Since</h3>
                                            <div class="grid md:grid-cols-2 gap-8">
                                                <div class="bg-blue-50 p-4 rounded-lg">
                                                    <h4 class="text-xl font-bold text-center text-[#118AB2] mb-2">For ğŸ—“ï¸ (Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ)</h4>
                                                    <ul class="space-y-2 text-sm text-gray-700 list-disc list-inside text-left dir-ltr">
                                                        <li>I have had a headache <strong class="text-[#118AB2]">for two days</strong>.</li>
                                                        <li>We have been friends <strong class="text-[#118AB2]">for more than 20 years</strong>.</li>
                                                    </ul>
                                                </div>
                                                <div class="bg-green-50 p-4 rounded-lg">
                                                    <h4 class="text-xl font-bold text-center text-[#06D6A0] mb-2">Since ğŸ“ (Ø¨Ø±Ø§ÛŒ Ù†Ù‚Ø·Ù‡ Ø´Ø±ÙˆØ¹)</h4>
                                                    <ul class="space-y-2 text-sm text-gray-700 list-disc list-inside text-left dir-ltr">
                                                        <li>I have lived here <strong class="text-[#06D6A0]">since 2000</strong>.</li>
                                                        <li>He hasn't called me <strong class="text-[#06D6A0]">since last night</strong>.</li>
                                                    </ul>
                                                </div>
                                            </div>
                                            <div class="mt-6 text-center bg-red-100 p-3 rounded-lg">
                                                <p class="font-bold text-red-700">âŒ Ø§Ø´ØªØ¨Ø§Ù‡ Ø±Ø§ÛŒØ¬: Ù‡Ø±Ú¯Ø² Ù†Ú¯ÙˆÛŒÛŒØ¯: <del class="font-mono">since 5 years ago</del></p>
                                            </div>
                                        </div>

                                        <!-- Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¨Ø§ Ú¯Ø°Ø´ØªÙ‡ Ø³Ø§Ø¯Ù‡ -->
                                        <div class="card p-6 text-center">
                                            <h3 class="text-2xl font-bold text-[#FF6B6B] mb-4">âš”ï¸ Ø­Ø§Ù„ Ú©Ø§Ù…Ù„ Ø¯Ø± Ù…Ù‚Ø§Ø¨Ù„ Ú¯Ø°Ø´ØªÙ‡ Ø³Ø§Ø¯Ù‡</h3>
                                            <div class="grid md:grid-cols-2 gap-8 items-center">
                                                <div>
                                                    <h4 class="text-xl font-bold text-[#06D6A0] mb-2">Ø­Ø§Ù„ Ú©Ø§Ù…Ù„ (Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ø§Ø±Ø¯)</h4>
                                                    <div class="chart-container"><canvas id="presentPerfectChart"></canvas></div>
                                                    <p class="font-mono bg-gray-100 p-2 mt-3 rounded-lg text-sm">How long <strong class="correct">have you lived</strong> here?</p>
                                                    <p class="text-xs text-gray-500 mt-1">(Ù‡Ù†ÙˆØ² Ù‡Ù… Ø§ÛŒÙ†Ø¬Ø§ Ø²Ù†Ø¯Ú¯ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒ)</p>
                                                </div>
                                                <div>
                                                    <h4 class="text-xl font-bold text-[#FF6B6B] mb-2">Ú¯Ø°Ø´ØªÙ‡ Ø³Ø§Ø¯Ù‡ (ØªÙ…Ø§Ù… Ø´Ø¯Ù‡)</h4>
                                                    <div class="chart-container"><canvas id="simplePastChart"></canvas></div>
                                                    <p class="font-mono bg-gray-100 p-2 mt-3 rounded-lg text-sm">How long <strong class="incorrect">did you live</strong> in Tabriz?</p>
                                                    <p class="text-xs text-gray-500 mt-1">(Ø¯ÛŒÚ¯Ø± Ø¯Ø± ØªØ¨Ø±ÛŒØ² Ø²Ù†Ø¯Ú¯ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†ÛŒ)</p>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Ø§ÙØ¹Ø§Ù„ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ùˆ Ø¨Ø§Ø²Ù‡â€ŒØ§ÛŒ -->
                                        <div class="card p-6">
                                            <h3 class="text-2xl font-bold text-[#FF6B6B] mb-4 text-center">âš¡ï¸ Ù‚Ù„Ø¨ Ø¯Ø±Ø³: Ø§ÙØ¹Ø§Ù„ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø¯Ø± Ù…Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ù‡â€ŒØ§ÛŒ ğŸƒâ€â™‚ï¸</h3>
                                            <div class="grid md:grid-cols-2 gap-8">
                                                <div class="p-4 bg-red-50 rounded-lg">
                                                    <h4 class="text-xl font-bold text-[#EF4444] mb-3">Ø§ÙØ¹Ø§Ù„ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ (Momentary)</h4>
                                                    <p class="text-sm text-gray-600 mb-2">Ø¯Ø± ÛŒÚ© Ø¢Ù† Ø§ØªÙØ§Ù‚ Ù…ÛŒâ€ŒØ§ÙØªÙ†Ø¯ (buy, arrive, get married, graduate).</p>
                                                    <p class="font-mono incorrect bg-white p-2 rounded">âŒ I <del>have arrived</del> for 2 hours.</p>
                                                    <p class="font-mono correct bg-white p-2 rounded mt-2">âœ… I <strong>have been here</strong> for 2 hours.</p>
                                                </div>
                                                <div class="p-4 bg-green-50 rounded-lg">
                                                    <h4 class="text-xl font-bold text-[#06D6A0] mb-3">Ø§ÙØ¹Ø§Ù„ Ø¨Ø§Ø²Ù‡â€ŒØ§ÛŒ (Durative)</h4>
                                                    <p class="text-sm text-gray-600 mb-2">Ø¯Ø± Ø·ÙˆÙ„ Ø²Ù…Ø§Ù† Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ø§Ø±Ù†Ø¯ (live, work, know, be, have).</p>
                                                    <p class="font-mono correct bg-white p-2 rounded">âœ… I <strong>have worked here</strong> for a year.</p>
                                                    <p class="font-mono correct bg-white p-2 rounded mt-2">âœ… She <strong>has been sick</strong> for a week.</p>
                                                </div>
                                            </div>
                                            <div class="mt-6 p-4 bg-yellow-100 rounded-lg text-center">
                                                <p class="font-bold text-[#073B4C]">ğŸ’¡ Ø§Ø³ØªØ«Ù†Ø§ÛŒ Ù…Ù‡Ù…: Ø¯Ø± Ø¬Ù…Ù„Ø§Øª <strong class="text-red-600">Ù…Ù†ÙÛŒ</strong>ØŒ Ù‡Ø± Ø¯Ùˆ Ù†ÙˆØ¹ ÙØ¹Ù„ Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡â€ŒØ§Ù†Ø¯!</p>
                                                 <p class="font-mono text-sm mt-2 text-gray-700">I <strong class="text-[#073B4C]">haven't bought</strong> anything for 2 years. (Ú©Ø§Ù…Ù„Ø§Ù‹ ØµØ­ÛŒØ­ Ø§Ø³Øª)</p>
                                            </div>
                                        </div>
                                        
                                        <!-- Ú©Ø§Ø±Ø¨Ø±Ø¯ Ø¯ÙˆÙ…: ØªØ¬Ø±Ø¨Ù‡ -->
                                         <div class="card p-6">
                                            <h3 class="text-2xl font-bold text-[#FF6B6B] mb-4 text-center">ğŸŒ Ú©Ø§Ø±Ø¨Ø±Ø¯ Ø¯ÙˆÙ…: Ø¨ÛŒØ§Ù† ØªØ¬Ø±Ø¨Ù‡ Ùˆ ØªØ¹Ø¯Ø§Ø¯ Ø¯ÙØ¹Ø§Øª</h3>
                                            <p class="text-center text-gray-600 mb-6">Ø¨Ø±Ø§ÛŒ ØµØ­Ø¨Øª Ø¯Ø± Ù…ÙˆØ±Ø¯ ØªØ¬Ø±Ø¨ÛŒØ§Øª Ú¯Ø°Ø´ØªÙ‡ (Ø¨Ø¯ÙˆÙ† Ø°Ú©Ø± Ø²Ù…Ø§Ù† Ø¯Ù‚ÛŒÙ‚) Ùˆ ØªØ¹Ø¯Ø§Ø¯ Ø¯ÙØ¹Ø§Øª Ø§Ù†Ø¬Ø§Ù… ÛŒÚ© Ú©Ø§Ø±.</p>
                                            <div class="bg-gray-100 p-4 rounded-lg text-left dir-ltr">
                                                <p class="font-mono text-lg text-[#118AB2] font-bold">Have you <strong class="text-[#FF6B6B]">ever</strong> eaten Moroccan food?</p>
                                                <div class="mt-4 space-y-2">
                                                    <p class="font-mono text-gray-700">No, I have <strong class="text-[#FF6B6B]">never</strong> eaten it.</p>
                                                    <p class="font-mono text-gray-700">Yes, I've had it <strong class="text-[#FF6B6B]">several times</strong>.</p>
                                                    <p class="font-mono text-gray-700 mt-4 border-t pt-2">This is the first time I <strong class="text-[#FF6B6B]">have driven</strong> a car.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </section>
                            </main>
                        </div>
                        <div class="proverb-banner">
                            <h4 class="text-sm font-semibold opacity-80 mb-2">ğŸ  Ø¶Ø±Ø¨ Ø§Ù„Ù…Ø«Ù„ Ø¬Ù„Ø³Ù‡ Û³Û¶</h4>
                            <p class="text-3xl font-bold">There is no place like home</p>
                            <p class="text-lg mt-3 opacity-90">"Ù‡ÛŒÚ† Ø¬Ø§ Ø®ÙˆÙ†Ù‡ Ø¢Ø¯Ù… Ù†Ù…ÛŒØ´Ù‡"</p>
                        </div>
                    `,
                    script: `
                        // This script will be executed when the lesson is shown
                        const chartOptions = {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '70%',
                            plugins: {
                                legend: { display: false },
                                tooltip: { enabled: false }
                            }
                        };

                        const presentPerfectCtx = document.getElementById('presentPerfectChart')?.getContext('2d');
                        if (presentPerfectCtx) {
                            new Chart(presentPerfectCtx, {
                                type: 'doughnut',
                                data: {
                                    labels: ['Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…', 'Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡'],
                                    datasets: [{
                                        data: [75, 25],
                                        backgroundColor: ['#06D6A0', '#e5e7eb'],
                                        borderColor: ['#ffffff'],
                                        borderWidth: 4
                                    }]
                                },
                                options: chartOptions
                            });
                        }

                        const simplePastCtx = document.getElementById('simplePastChart')?.getContext('2d');
                        if (simplePastCtx) {
                            new Chart(simplePastCtx, {
                                type: 'doughnut',
                                data: {
                                    labels: ['ØªÙ…Ø§Ù… Ø´Ø¯Ù‡'],
                                    datasets: [{
                                        data: [100],
                                        backgroundColor: ['#FF6B6B'],
                                        borderColor: ['#ffffff'],
                                        borderWidth: 4
                                    }]
                                },
                                options: chartOptions
                            });
                        }
                    `
                }
            ];

            const storyContent = [
                { type: 'h2', text: 'A Fresh Start' },
                { type: 'p', text: 'Alex <span class="highlight" data-fa-translation="Ø¨Ø±Ø§ÛŒ Ù¾Ù†Ø¬ Ø³Ø§Ù„ Ø²Ù†Ø¯Ú¯ÛŒ Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª">has lived</span> in London <span class="highlight" data-fa-translation="Ø¨Ø±Ø§ÛŒ Ù¾Ù†Ø¬ Ø³Ø§Ù„">for five years</span>. He <span class="highlight" data-fa-translation="Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø·Ø±Ø§Ø­ Ú¯Ø±Ø§ÙÛŒÚ© Ú©Ø§Ø± Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª">has worked</span> as a graphic designer <span class="highlight" data-fa-translation="Ø§Ø² ÙˆÙ‚ØªÛŒ Ú©Ù‡ ÙØ§Ø±Øºâ€ŒØ§Ù„ØªØ­ØµÛŒÙ„ Ø´Ø¯">since he graduated</span> from university. Recently, he <span class="highlight" data-fa-translation="Ø§Ø­Ø³Ø§Ø³ Ø®Ø³ØªÚ¯ÛŒ Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª">has felt</span> bored. "I <span class="highlight" data-fa-translation="Ø¨Ø±Ø§ÛŒ Ù…Ø¯Øª Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø§Ù…ØªØ­Ø§Ù† Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§Ù…">haven\'t tried</span> anything new for a long time," he thought.' },
                { type: 'p', text: 'One day, his friend asked, "<span class="highlight" data-fa-translation="Ø¢ÛŒØ§ ØªØ§ Ø¨Ù‡ Ø­Ø§Ù„ ÙÚ©Ø± Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒ">Have you ever thought</span> about moving to another country?" Alex was surprised. "<span class="highlight" data-fa-translation="Ø¯Ùˆ Ø¯Ù„ Ù‡Ø³ØªÙ…">I\'m in two minds</span>," he said. "I love London, but maybe I need a change. <span class="highlight" data-fa-translation="Ù‡ÛŒÚ† Ø¬Ø§ Ø®ÙˆÙ†Ù‡ Ø¢Ø¯Ù… Ù†Ù…ÛŒØ´Ù‡">There is no place like home</span>, but maybe it\'s time for a new home."' },
                { type: 'p', text: '"<span class="highlight" data-fa-translation="Ø§Ú¯Ø± Ø§Ø´ØªØ¨Ø§Ù‡ Ù†Ú©Ù†Ù…">If I\'m not mistaken</span>, you <span class="highlight" data-fa-translation="Ù‡Ù…ÛŒØ´Ù‡ Ø®ÙˆØ§Ø³ØªÙ‡â€ŒØ§ÛŒ">have always wanted</span> to visit Japan," his friend said. "That\'s true! I <span class="highlight" data-fa-translation="Ø§Ø² Ø¨Ú†Ú¯ÛŒ Ù…ÛŒâ€ŒØ®ÙˆØ§Ø³ØªÙ…">have wanted</span> to go there <span class="highlight" data-fa-translation="Ø§Ø² ÙˆÙ‚ØªÛŒ Ø¨Ú†Ù‡ Ø¨ÙˆØ¯Ù…">since I was a child</span>. But <span class="highlight" data-fa-translation="Ù†Ù…ÛŒâ€ŒØ¯Ø§Ù†Ù… Ú†Ù‡ Ú©Ù†Ù…">I don\'t know what to do</span>."' },
                { type: 'p', text: 'For the first time, Alex felt excited about the future. He decided to research jobs in Tokyo. "I <span class="highlight" data-fa-translation="Ù‡Ù†ÙˆØ² Ø¨Ù„ÛŒØ· Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§ Ù†Ø®Ø±ÛŒØ¯Ù‡â€ŒØ§Ù…">haven\'t bought</span> a plane ticket yet, but I <span class="highlight" data-fa-translation="ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ú˜Ø§Ù¾Ù†ÛŒ Ø±Ø§ Ø´Ø±ÙˆØ¹ Ú©Ø±Ø¯Ù‡â€ŒØ§Ù…">have already started</span> learning Japanese!" he told his friend a week later.' }
            ];

            const vocabCards = [
                { front: "I'm in two minds.", back_fa: 'Ø¯Ùˆ Ø¯Ù„ Ù‡Ø³ØªÙ….', back_en: "I can't decide if I should take the job or not. I'm in two minds.", text_to_speak_main: "I'm in two minds.", text_to_speak_example: "I can't decide if I should take the job or not. I'm in two minds." },
                { front: "If I'm not mistaken.", back_fa: 'Ø§Ú¯Ø± Ø§Ø´ØªØ¨Ø§Ù‡ Ù†Ú©Ù†Ù….', back_en: "If I'm not mistaken, we have met before.", text_to_speak_main: "If I'm not mistaken.", text_to_speak_example: "If I'm not mistaken, we have met before." },
                { front: "It's delicious.", back_fa: 'Ø®ÙˆØ´Ù…Ø²Ù‡ Ø§Ø³Øª.', back_en: "The cake you made is delicious.", text_to_speak_main: "It's delicious.", text_to_speak_example: "The cake you made is delicious." },
                { front: "It's disgusting.", back_fa: 'Ø­Ø§Ù„ Ø¨Ù‡Ù… Ø²Ù† Ø§Ø³Øª.', back_en: "I find the smell of that cheese absolutely disgusting.", text_to_speak_main: "It's disgusting.", text_to_speak_example: "I find the smell of that cheese absolutely disgusting." },
                { front: "I didn't know that.", back_fa: 'Ø§ÛŒÙ† Ø±Ø§ Ù†Ù…ÛŒâ€ŒØ¯Ø§Ù†Ø³ØªÙ….', back_en: "A: 'Did you know that penguins can't fly?' B: 'No, I didn't know that.'", text_to_speak_main: "I didn't know that.", text_to_speak_example: "No, I didn't know that." },
                { front: "There is no place like home.", back_fa: 'Ù‡ÛŒÚ† Ø¬Ø§ Ø®Ø§Ù†Ù‡ Ø¢Ø¯Ù… Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯.', back_en: "After a long trip, it's always good to be back. There is no place like home.", text_to_speak_main: "There is no place like home.", text_to_speak_example: "After a long trip, it's always good to be back. There is no place like home." },
                { front: "I don't know what to do.", back_fa: 'Ù†Ù…ÛŒâ€ŒØ¯Ø§Ù†Ù… Ú†Ù‡ Ú©Ù†Ù….', back_en: "I've lost my keys and I don't know what to do.", text_to_speak_main: "I don't know what to do.", text_to_speak_example: "I've lost my keys and I don't know what to do." },
                { front: "I don't know where to go.", back_fa: 'Ù†Ù…ÛŒâ€ŒØ¯Ø§Ù†Ù… Ú©Ø¬Ø§ Ø¨Ø±ÙˆÙ….', back_en: "I'm new in this city and I don't know where to go for a good coffee.", text_to_speak_main: "I don't know where to go.", text_to_speak_example: "I'm new in this city and I don't know where to go for a good coffee." },
                { front: "For", back_fa: 'Ø¨Ø±Ø§ÛŒ (ÛŒÚ© Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ)', back_en: "I have studied English for three years.", text_to_speak_main: "For", text_to_speak_example: "I have studied English for three years." },
                { front: "Since", back_fa: 'Ø§Ø² (ÛŒÚ© Ù†Ù‚Ø·Ù‡ Ø´Ø±ÙˆØ¹)', back_en: "She has lived here since 2020.", text_to_speak_main: "Since", text_to_speak_example: "She has lived here since 2020." },
                { front: "Ever", back_fa: 'ØªØ§ Ø¨Ù‡ Ø­Ø§Ù„ (Ø¯Ø± Ø³ÙˆØ§Ù„)', back_en: "Have you ever been to Italy?", text_to_speak_main: "Ever", text_to_speak_example: "Have you ever been to Italy?" },
                { front: "Never", back_fa: 'Ù‡Ø±Ú¯Ø²', back_en: "I have never seen a ghost.", text_to_speak_main: "Never", text_to_speak_example: "I have never seen a ghost." },
                { front: "Several times", back_fa: 'Ú†Ù†Ø¯ÛŒÙ† Ø¨Ø§Ø±', back_en: "I have visited that museum several times.", text_to_speak_main: "Several times", text_to_speak_example: "I have visited that museum several times." }
            ];

            const grammarCards = [
                { front: 'Ø¯Ù‡ Ø³Ø§Ù„Ù‡ Ø¯Ø± ØªÙ‡Ø±Ø§Ù† Ø²Ù†Ø¯Ú¯ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ù…', back_main: 'I have lived in Tehran for 10 years.', back_example: 'I have lived in Tehran for 10 years.', text_to_speak_main: 'I have lived in Tehran for 10 years.', text_to_speak_example: 'I have lived in Tehran for 10 years.' },
                { front: 'Ø¯Ùˆ Ø³Ø§Ù„Ù‡ Ø¹ÛŒÙ†Ú© Ù…ÛŒâ€ŒØ²Ù†Ù…', back_main: 'I have worn glasses for 2 years.', back_example: 'I have worn glasses for 2 years.', text_to_speak_main: 'I have worn glasses for 2 years.', text_to_speak_example: 'I have worn glasses for 2 years.' },
                { front: 'Ø´Ø´ Ù…Ø§Ù‡Ù‡ Ø§ÛŒÙ† Ø®Ø§Ù†Ù… Ø±Ø§ Ù…ÛŒâ€ŒØ´Ù†Ø§Ø³Ù…', back_main: 'I have known this lady for 6 months.', back_example: 'I have known this lady for 6 months.', text_to_speak_main: 'I have known this lady for 6 months.', text_to_speak_example: 'I have known this lady for 6 months.' },
                { front: 'Ø¯Ùˆ Ø±ÙˆØ²Ù‡ Ø³Ø±Ø¯Ø±Ø¯ Ø¯Ø§Ø±Ù…', back_main: 'I have had a headache for 2 days.', back_example: 'I have had a headache for 2 days.', text_to_speak_main: 'I have had a headache for 2 days.', text_to_speak_example: 'I have had a headache for 2 days.' },
                { front: 'ÛŒÚ© Ø³Ø§Ø¹ØªÙ‡ Ø§ÛŒÙ†Ø¬Ø§ Ù‡Ø³ØªÙ…', back_main: 'I have been here for an hour.', back_example: 'I have been here for an hour.', text_to_speak_main: 'I have been here for an hour.', text_to_speak_example: 'I have been here for an hour.' },
                { front: 'Ø­Ø¯ÙˆØ¯ Ù¾Ù†Ø¬ Ø³Ø§Ù„Ù‡ Ø¹ÛŒÙ†Ú© Ù…ÛŒâ€ŒØ²Ù†Ù…', back_main: 'I have worn glasses for about 5 years.', back_example: 'I have worn glasses for about 5 years.', text_to_speak_main: 'I have worn glasses for about 5 years.', text_to_speak_example: 'I have worn glasses for about 5 years.' },
                { front: 'Ù‡Ø´Øª Ù…Ø§Ù‡Ù‡ Ø±ÛŒØ´ Ø¯Ø§Ø±ÛŒ', back_main: 'You have had a beard for 8 months.', back_example: 'You have had a beard for 8 months.', text_to_speak_main: 'You have had a beard for 8 months.', text_to_speak_example: 'You have had a beard for 8 months.' },
                { front: 'Ø¯Ùˆ Ù…Ø§Ù‡Ù‡ ÙˆØ±Ø²Ø´ Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒÙ…', back_main: 'We havenâ€™t exercised for 2 months.', back_example: 'We havenâ€™t exercised for 2 months.', text_to_speak_main: 'We havenâ€™t exercised for 2 months.', text_to_speak_example: 'We havenâ€™t exercised for 2 months.' },
                { front: 'Ø¯Ùˆ Ù…Ø§Ù‡Ù‡ Ù‚Ù‡ÙˆÙ‡ Ù†Ø®ÙˆØ±Ø¯Ù‡â€ŒØ§ÛŒ', back_main: 'You havenâ€™t drunk coffee for 2 months.', back_example: 'You havenâ€™t drunk coffee for 2 months.', text_to_speak_main: 'You havenâ€™t drunk coffee for 2 months.', text_to_speak_example: 'You havenâ€™t drunk coffee for 2 months.' },
                { front: 'ÛŒÚ© Ù…Ø§Ù‡Ù‡ ÙÛŒÙ„Ù… Ù†Ø¯ÛŒØ¯Ù‡â€ŒØ§ÛŒ', back_main: 'You havenâ€™t watched a movie for a month.', back_example: 'You havenâ€™t watched a movie for a month.', text_to_speak_main: 'You havenâ€™t watched a movie for a month.', text_to_speak_example: 'You havenâ€™t watched a movie for a month.' },
                { front: 'Ø´Ø´ Ù…Ø§Ù‡Ù‡ Ù…Ùˆ Ú©ÙˆØªØ§Ù‡ Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒ', back_main: 'You havenâ€™t cut your hair for 6 months.', back_example: 'You havenâ€™t cut your hair for 6 months.', text_to_speak_main: 'You havenâ€™t cut your hair for 6 months.', text_to_speak_example: 'You havenâ€™t cut your hair for 6 months.' },
                { front: 'Ø¯Ùˆ Ù‡ÙØªÙ‡ Ø§Ø³Øª Ø§ÛŒÙ†Ø¬Ø§ Ù†Ø¨ÙˆØ¯Ù‡â€ŒØ§ÛŒ', back_main: 'You havenâ€™t been here for 2 weeks.', back_example: 'You havenâ€™t been here for 2 weeks.', text_to_speak_main: 'You havenâ€™t been here for 2 weeks.', text_to_speak_example: 'You havenâ€™t been here for 2 weeks.' },
                { front: 'Ø¯Ùˆ Ù‡ÙØªÙ‡ Ø§Ø³Øª Ù…Ø§Ø´ÛŒÙ† Ù†Ø±Ø§Ù†Ø¯Ù‡â€ŒØ§ÛŒ', back_main: 'You havenâ€™t driven a car for 2 weeks.', back_example: 'You havenâ€™t driven a car for 2 weeks.', text_to_speak_main: 'You havenâ€™t driven a car for 2 weeks.', text_to_speak_example: 'You havenâ€™t driven a car for 2 weeks.' },
                { front: 'Ø¯Ùˆ Ø³Ø§Ù„Ù‡ ØªÙ†ÛŒØ³ Ø¨Ø§Ø²ÛŒ Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒ', back_main: 'You havenâ€™t played tennis for 2 years.', back_example: 'You havenâ€™t played tennis for 2 years.', text_to_speak_main: 'You havenâ€™t played tennis for 2 years.', text_to_speak_example: 'You havenâ€™t played tennis for 2 years.' },
                { front: 'Ø§ÛŒÙ† Ø¢Ù‚Ø§ ÛŒÚ© Ù‡ÙØªÙ‡ Ø§Ø³Øª Ø¨Ù‡ Ù…Ù† Ø²Ù†Ú¯ Ù†Ø²Ø¯Ù‡', back_main: 'This man hasnâ€™t called me for a week.', back_example: 'This man hasnâ€™t called me for a week.', text_to_speak_main: 'This man hasnâ€™t called me for a week.', text_to_speak_example: 'This man hasnâ€™t called me for a week.' },
                { front: 'Ø®ÙˆØ§Ù‡Ø±Ù… ÛŒÚ© Ù…Ø§Ù‡ Ø§Ø³Øª Ø¨Ù‡ Ù…Ù† Ø²Ù†Ú¯ Ù†Ø²Ø¯Ù‡', back_main: 'My sister hasnâ€™t called me for a month.', back_example: 'My sister hasnâ€™t called me for a month.', text_to_speak_main: 'My sister hasnâ€™t called me for a month.', text_to_speak_example: 'My sister hasnâ€™t called me for a month.' },
                { front: 'Ø®ÛŒÙ„ÛŒ ÙˆÙ‚ØªÙ‡ Ø¨Ù‡ Ù…Ù† Ø³Ø± Ù†Ø²Ø¯Ù‡', back_main: 'He hasnâ€™t visited me for a long time.', back_example: 'He hasnâ€™t visited me for a long time.', text_to_speak_main: 'He hasnâ€™t visited me for a long time.', text_to_speak_example: 'He hasnâ€™t visited me for a long time.' },
                { front: 'ÛŒÚ© Ù‡ÙØªÙ‡ Ø§Ø³Øª Ø¯ÙˆØ´ Ù†Ú¯Ø±ÙØªÙ‡', back_main: 'He hasnâ€™t taken a bath for a week.', back_example: 'He hasnâ€™t taken a bath for a week.', text_to_speak_main: 'He hasnâ€™t taken a bath for a week.', text_to_speak_example: 'He hasnâ€™t taken a bath for a week.' },
                { front: 'Ø´Ø´ Ù…Ø§Ù‡Ù‡ Ú©Ø¨Ø§Ø¨ Ù†Ø®ÙˆØ±Ø¯Ù‡â€ŒØ§ÛŒÙ…', back_main: 'We havenâ€™t eaten kebab for 6 months.', back_example: 'We havenâ€™t eaten kebab for 6 months.', text_to_speak_main: 'We havenâ€™t eaten kebab for 6 months.', text_to_speak_example: 'We havenâ€™t eaten kebab for 6 months.' },
                { front: 'Ø¯Ùˆ Ù…Ø§Ù‡Ù‡ Ø¨Ø±Ù†Ø¬ Ù†Ø®ÙˆØ±Ø¯Ù‡â€ŒØ§ÛŒ', back_main: 'You havenâ€™t eaten rice for 2 months.', back_example: 'You havenâ€™t eaten rice for 2 months.', text_to_speak_main: 'You havenâ€™t eaten rice for 2 months.', text_to_speak_example: 'You havenâ€™t eaten rice for 2 months.' },
                { front: 'Ø¯Ùˆ Ù…Ø§Ù‡Ù‡ Ø¨Ù‡ Ù…Ø§ Ø³Ø± Ù†Ø²Ø¯Ù‡', back_main: 'He hasnâ€™t visited us for 2 months.', back_example: 'He hasnâ€™t visited us for 2 months.', text_to_speak_main: 'He hasnâ€™t visited us for 2 months.', text_to_speak_example: 'He hasnâ€™t visited us for 2 months.' },
                { front: 'ÛŒÚ© Ù…Ø§Ù‡ Ø§Ø³Øª Ø¨Ù‡ Ø¨Ø§Ø´Ú¯Ø§Ù‡ Ù†Ø±ÙØªÙ‡â€ŒØ§ÛŒØ¯', back_main: 'You havenâ€™t gone to the gym for a month.', back_example: 'You havenâ€™t gone to the gym for a month.', text_to_speak_main: 'You havenâ€™t gone to the gym for a month.', text_to_speak_example: 'You havenâ€™t gone to the gym for a month.' },
                { front: 'ÛŒÚ© Ø³Ø§Ù„ Ø§Ø³Øª Ø¯Ø¹ÙˆØ§ Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒ', back_main: 'You havenâ€™t fought for a year.', back_example: 'You havenâ€™t fought for a year.', text_to_speak_main: 'You havenâ€™t fought for a year.', text_to_speak_example: 'You havenâ€™t fought for a year.' },
                { front: 'Ø³Ù‡ Ø´Ø¨ Ø§Ø³Øª Ø®ÙˆØ¨ Ù†Ø®ÙˆØ§Ø¨ÛŒØ¯Ù‡â€ŒØ§Ù…', back_main: 'I havenâ€™t slept well for three nights.', back_example: 'I havenâ€™t slept well for three nights.', text_to_speak_main: 'I havenâ€™t slept well for three nights.', text_to_speak_example: 'I havenâ€™t slept well for three nights.' },
                { front: 'Ø§Ø² Ø¬Ù…Ø¹Ù‡ Ø³Ø±Ø¯Ø±Ø¯ Ø¯Ø§Ø±Ù…', back_main: 'I have had a headache since Friday.', back_example: 'I have had a headache since Friday.', text_to_speak_main: 'I have had a headache since Friday.', text_to_speak_example: 'I have had a headache since Friday.' },
                { front: 'Ø§Ø² Ø³Ø§Ù„ Û²Û°Û°Û² Ø§ÛŒÙ†Ø¬Ø§ Ø²Ù†Ø¯Ú¯ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ù…', back_main: 'I have lived here since 2002.', back_example: 'I have lived here since 2002.', text_to_speak_main: 'I have lived here since 2002.', text_to_speak_example: 'I have lived here since 2002.' },
                { front: 'Ø§Ø² Ù‡ÙØªÙ‡ Ù¾ÛŒØ´ Ø§ÛŒÙ†Ø¬Ø§ Ù‡Ø³ØªÙ…', back_main: 'I have been here since last week.', back_example: 'I have been here since last week.', text_to_speak_main: 'I have been here since last week.', text_to_speak_example: 'I have been here since last week.' },
                { front: 'Ø§Ø² ÙˆÙ‚ØªÛŒ Ø§Ø³ØªØ¹ÙØ§ Ø¯Ø§Ø¯Ù…ØŒ Ù‡Ù…Ú©Ø§Ø±Ø§Ù†Ù… Ø±Ø§ Ù†Ø¯ÛŒØ¯Ù‡â€ŒØ§Ù…', back_main: 'I havenâ€™t seen my colleagues since I resigned.', back_example: 'I havenâ€™t seen my colleagues since I resigned.', text_to_speak_main: 'I havenâ€™t seen my colleagues since I resigned.', text_to_speak_example: 'I havenâ€™t seen my colleagues since I resigned.' },
                { front: 'Ø§Ø² ÙˆÙ‚ØªÛŒ Ø¨Ù‡ Ø¯Ù†ÛŒØ§ Ø¢Ù…Ø¯Ù‡â€ŒØ§Ù… Ø¯Ø± ØªÙ‡Ø±Ø§Ù† Ø²Ù†Ø¯Ú¯ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ù…', back_main: 'I have lived in Tehran since I was born.', back_example: 'I have lived in Tehran since I was born.', text_to_speak_main: 'I have lived in Tehran since I was born.', text_to_speak_example: 'I have lived in Tehran since I was born.' },
                { front: 'Ø§Ø² Ø¢ÙˆØ±ÛŒÙ„ Ø³ÛŒÚ¯Ø§Ø± Ù†Ú©Ø´ÛŒØ¯Ù‡â€ŒØ§Ù…', back_main: 'I havenâ€™t smoked since April.', back_example: 'I havenâ€™t smoked since April.', text_to_speak_main: 'I havenâ€™t smoked since April.', text_to_speak_example: 'I havenâ€™t smoked since April.' },
                { front: 'Ø§Ø² Ø³Ø§Ù„ Û±Û¹Û¹Û° ÙÙˆØªØ¨Ø§Ù„ Ø¨Ø§Ø²ÛŒ Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª', back_main: 'He has played football since 1990.', back_example: 'He has played football since 1990.', text_to_speak_main: 'He has played football since 1990.', text_to_speak_example: 'He has played football since 1990.' },
                { front: 'Ø§Ø² Ø³Ø§Ù„ Û±Û¹Û·Ûµ Ø¯Ø± Ø§ÛŒÙ† Ø®Ø§Ù†Ù‡ Ø²Ù†Ø¯Ú¯ÛŒ Ú©Ø±Ø¯Ù‡â€ŒØ§Ù…', back_main: 'I have lived in this house since 1975.', back_example: 'I have lived in this house since 1975.', text_to_speak_main: 'I have lived in this house since 1975.', text_to_speak_example: 'I have lived in this house since 1975.' },
                { front: 'Ø§Ø² ÙˆÙ‚ØªÛŒ Ø¨Ù‡ ØªÙ‡Ø±Ø§Ù† Ø¢Ù…Ø¯Ù‡â€ŒØ§Ù… Ø¨Ø±Ø§ÛŒ Ø³Ø§Ù…Ø³ÙˆÙ†Ú¯ Ú©Ø§Ø± Ú©Ø±Ø¯Ù‡â€ŒØ§Ù…', back_main: 'I have worked for Samsung since I came to Tehran.', back_example: 'I have worked for Samsung since I came to Tehran.', text_to_speak_main: 'I have worked for Samsung since I came to Tehran.', text_to_speak_example: 'I have worked for Samsung since I came to Tehran.' },
                { front: 'Ø§Ø² Ø¨Ø¯Ùˆ ØªÙˆÙ„Ø¯ Ø¯Ø± ÙÙ‚Ø± Ø²Ù†Ø¯Ú¯ÛŒ Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª', back_main: 'She has lived in poverty since birth.', back_example: 'She has lived in poverty since birth.', text_to_speak_main: 'She has lived in poverty since birth.', text_to_speak_example: 'She has lived in poverty since birth.' },
                { front: 'Ø§Ø² ÙˆÙ‚ØªÛŒ Ú©Ø§Øª Ú©Ø±Ø¯ÛŒÙ… Ø¨Ù‡ Ù…Ù† Ø²Ù†Ú¯ Ù†Ø²Ø¯Ù‡', back_main: 'She hasnâ€™t called me since we broke up.', back_example: 'She hasnâ€™t called me since we broke up.', text_to_speak_main: 'She hasnâ€™t called me since we broke up.', text_to_speak_example: 'She hasnâ€™t called me since we broke up.' },
                { front: 'Ø§Ø² ÙˆÙ‚ØªÛŒ Ø±Ú˜ÛŒÙ… Ú¯Ø±ÙØªÙ‡â€ŒØ§Ù… ÙØ³Øªâ€ŒÙÙˆØ¯ Ù†Ø®ÙˆØ±Ø¯Ù‡â€ŒØ§Ù…', back_main: 'I havenâ€™t eaten fast food since I went on a diet.', back_example: 'I havenâ€™t eaten fast food since I went on a diet.', text_to_speak_main: 'I havenâ€™t eaten fast food since I went on a diet.', text_to_speak_example: 'I havenâ€™t eaten fast food since I went on a diet.' },
                { front: 'Ø§Ø² ÙˆÙ‚ØªÛŒ Ø§Ø² ØªØ±Ú©ÛŒÙ‡ Ø¨Ø±Ú¯Ø´ØªÙ‡ Ø¨Ù‡ Ù…Ù† Ø³Ø± Ù†Ø²Ø¯Ù‡', back_main: 'She hasnâ€™t visited me since she came back from Turkey.', back_example: 'She hasnâ€™t visited me since she came back from Turkey.', text_to_speak_main: 'She hasnâ€™t visited me since she came back from Turkey.', text_to_speak_example: 'She hasnâ€™t visited me since she came back from Turkey.' },
                { front: 'ÛŒÚ© Ø³Ø§Ù„Ù‡ Ø§ÛŒÙ† Ú¯ÙˆØ´ÛŒ Ø±Ø§ Ø¯Ø§Ø±Ù… (ØµØ­ÛŒØ­)', back_main: 'I have had this phone for a year.', back_example: 'ÙØ¹Ù„ have ÛŒÚ© ÙØ¹Ù„ Ø¨Ø§Ø²Ù‡â€ŒØ§ÛŒ (durative) Ø§Ø³Øª.', text_to_speak_main: 'I have had this phone for a year.', text_to_speak_example: 'The verb have is a durative verb.' },
                { front: 'Ø§ÛŒÙ† Ú¯ÙˆØ´ÛŒ Ø±Ø§ ÛŒÚ© Ø³Ø§Ù„Ù‡ Ø®Ø±ÛŒØ¯Ù‡â€ŒØ§Ù… (Ø§Ø´ØªØ¨Ø§Ù‡)', back_main: 'I have bought this phone for a year.', back_example: 'Ø§ÛŒÙ† Ø¬Ù…Ù„Ù‡ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª Ú†ÙˆÙ† buy ÛŒÚ© ÙØ¹Ù„ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ (momentary) Ø§Ø³Øª.', text_to_speak_main: 'I have bought this phone for a year.', text_to_speak_example: 'This sentence is incorrect because buy is a momentary verb.' },
                { front: 'Ú†Ù†Ø¯ ÙˆÙ‚ØªÙ‡ Ø§ÛŒÙ†Ø¬Ø§ÛŒÛŒØŸ (Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ø§Ø±Ø¯)', back_main: 'How long have you been here?', back_example: 'This question implies you are still here.', text_to_speak_main: 'How long have you been here?', text_to_speak_example: 'This question implies you are still here.' },
                { front: 'Ú†Ù†Ø¯ ÙˆÙ‚Øª Ø¯Ø± ØªØ§ÛŒÙ„Ù†Ø¯ Ø²Ù†Ø¯Ú¯ÛŒ Ú©Ø±Ø¯ÛŒØŸ (ØªÙ…Ø§Ù… Ø´Ø¯Ù‡)', back_main: 'How long did you live in Thailand?', back_example: 'This question implies you do not live there anymore.', text_to_speak_main: 'How long did you live in Thailand?', text_to_speak_example: 'This question implies you do not live there anymore.' }
            ];
            
            // --- App State & Functions ---
            let currentSession = { cards: [], currentIndex: 0, type: '', knownCount: 0, unknownCount: 0 };
            let preferredVoice = null;
            let voices = [];

            function loadAndSetVoice() {
                voices = window.speechSynthesis.getVoices();
                preferredVoice = voices.find(v => v.name.includes('Google') && v.lang.startsWith('en')) || voices.find(v => v.lang.startsWith('en') && !v.localService) || voices.find(v => v.lang.startsWith('en')) || voices[0];
            }
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadAndSetVoice;
            }
            loadAndSetVoice();

            function speakText(text) {
                if (window.speechSynthesis.speaking) {
                    window.speechSynthesis.cancel();
                }
                if (voices.length === 0) loadAndSetVoice();
                const utter = new SpeechSynthesisUtterance(text);
                utter.voice = preferredVoice;
                utter.lang = preferredVoice?.lang || 'en-US';
                utter.rate = 0.9;
                utter.pitch = 1;
                window.speechSynthesis.speak(utter);
            }

            function showCard(index) {
                if (index >= currentSession.cards.length) {
                    showResults();
                    return;
                }
                const cardData = currentSession.cards[index];
                const cardFront = document.getElementById('card-front');
                const cardBack = document.getElementById('card-back');
                const flashcard = document.querySelector('#practice-view .flashcard');
                flashcard.classList.remove('is-flipped');
                
                interactiveButtons.classList.add('hidden');
                
                prevCardBtn.style.visibility = (index > 0) ? 'visible' : 'hidden';
                nextCardBtn.style.visibility = 'hidden';
                
                setTimeout(() => {
                    if (currentSession.type === 'vocab') {
                        cardFront.innerHTML = `<h3 class="text-2xl font-bold p-4">${cardData.front}</h3>`;
                        cardBack.innerHTML = `<div class="p-4 flex-grow flex flex-col justify-center items-center">
                                                <p class="text-xl font-semibold">${cardData.back_fa}</p>
                                                <p class="text-base italic mt-2 text-slate-600">"${cardData.back_en}"</p>
                                                <div class="flex gap-4">
                                                    <button class="pronunciation-button" data-text="${cardData.text_to_speak_main}"><i class="fa-solid fa-volume-high"></i><span>Ú©Ù„Ù…Ù‡</span></button>
                                                    <button class="pronunciation-button" data-text="${cardData.text_to_speak_example}"><i class="fa-solid fa-volume-high"></i><span>Ù…Ø«Ø§Ù„</span></button>
                                                </div>
                                              </div>`;
                    } else { // Grammar
                        cardFront.innerHTML = `<h3 class="text-xl font-semibold p-4">${cardData.front}</h3>`;
                        cardBack.innerHTML = `<div class="p-4 flex-grow flex flex-col justify-center items-center text-left dir-ltr">
                                                <p class="font-bold text-lg">${cardData.back_main}</p>
                                                <p class="text-base italic mt-2 text-slate-600">"${cardData.back_example}"</p>
                                                <div class="flex gap-4">
                                                    <button class="pronunciation-button" data-text="${cardData.text_to_speak_main}">
                                                        <i class="fa-solid fa-volume-high"></i><span>Ø¬Ù…Ù„Ù‡</span>
                                                    </button>
                                                     <button class="pronunciation-button" data-text="${cardData.text_to_speak_example}">
                                                        <i class="fa-solid fa-volume-high"></i><span>Ù…Ø«Ø§Ù„</span>
                                                    </button>
                                                </div>
                                              </div>`;
                    }
                }, 150);
                cardCounter.textContent = `${index + 1} / ${currentSession.cards.length}`;
            }

            function renderLesson() {
                const backButton = lessonContentContainer.querySelector('.back-to-menu-btn').parentElement;
                lessonContentContainer.innerHTML = '';
                const item = lesson36Content[0];
                if (item && item.type === 'raw_html') {
                    lessonContentContainer.innerHTML = item.html;
                    if (item.script) {
                        // A safer way to execute script
                        try {
                           new Function(item.script)();
                        } catch(e) {
                            console.error("Error executing lesson script:", e);
                        }
                    }
                } else {
                    lessonContentContainer.innerHTML = '<p class="text-center text-slate-500">Ù…Ø­ØªÙˆØ§ÛŒ Ø¯Ø±Ø³ Ù‡Ù†ÙˆØ² Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
                }
                lessonContentContainer.appendChild(backButton);
            }

            function renderStory() {
                const backButton = storyContentContainer.querySelector('.back-to-menu-btn').parentElement;
                storyContentContainer.innerHTML = '';
                if (storyContent.length === 0) {
                    storyContentContainer.innerHTML = '<p class="text-center text-slate-500">Ù…Ø­ØªÙˆØ§ÛŒ Ø¯Ø§Ø³ØªØ§Ù† Ù‡Ù†ÙˆØ² Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
                } else {
                    storyContent.forEach(item => {
                        let el;
                        switch (item.type) {
                            case 'h2':
                                el = document.createElement('h2');
                                el.className = 'text-3xl font-bold text-center mb-10 text-slate-800';
                                el.textContent = item.text;
                                break;
                            case 'p':
                                el = document.createElement('p');
                                el.innerHTML = item.text;
                                break;
                        }
                        if (el) storyContentContainer.appendChild(el);
                    });
                }
                storyContentContainer.appendChild(backButton);
                storyContentContainer.querySelectorAll('.highlight').forEach(highlightEl => {
                    const translation = highlightEl.dataset.faTranslation;
                    if (translation) {
                        const tooltip = document.createElement('span');
                        tooltip.className = 'tooltip-text';
                        tooltip.textContent = translation;
                        highlightEl.appendChild(tooltip);
                    }
                });
            }

            function startPractice(type) {
                mainMenuView.classList.add('hidden');
                resultsView.classList.add('hidden');
                storyView.classList.add('hidden');
                lessonView.classList.add('hidden');
                practiceView.classList.remove('hidden');
                practiceView.classList.add('fade-in');
                let cardsToPractice = [];
                if (type === 'vocab') {
                    cardsToPractice = vocabCards;
                    headerSubtitle.textContent = 'ØªÙ…Ø±ÛŒÙ† Ú©Ù„Ù…Ø§Øª Ùˆ Ø§ØµØ·Ù„Ø§Ø­Ø§Øª';
                } else if (type === 'grammar') {
                    cardsToPractice = grammarCards;
                    headerSubtitle.textContent = 'ØªÙ…Ø±ÛŒÙ† Ú¯Ø±Ø§Ù…Ø±';
                }
                if (cardsToPractice.length === 0) {
                    document.getElementById('review-area').innerHTML = '<p class="text-center text-slate-500 py-10">Ù‡ÛŒÚ† Ú©Ø§Ø±ØªÛŒ Ø¨Ø±Ø§ÛŒ ØªÙ…Ø±ÛŒÙ† Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø®Ø´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>';
                    return;
                }
                currentSession.cards = shuffleArray([...cardsToPractice]);
                currentSession.type = type;
                currentSession.currentIndex = 0;
                currentSession.knownCount = 0;
                currentSession.unknownCount = 0;
                saveResultsBtn.disabled = false;
                saveResultsBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                saveMessage.textContent = '';
                showCard(0);
            }

            function showLesson() {
                mainMenuView.classList.add('hidden');
                practiceView.classList.add('hidden');
                resultsView.classList.add('hidden');
                storyView.classList.add('hidden');
                lessonView.classList.remove('hidden');
                lessonView.classList.add('fade-in');
                headerSubtitle.textContent = 'Ø¯Ø±Ø³ Ø¬Ù„Ø³Ù‡ Û³Û¶';
                renderLesson();
            }

            function showStory() {
                mainMenuView.classList.add('hidden');
                practiceView.classList.add('hidden');
                resultsView.classList.add('hidden');
                lessonView.classList.add('hidden');
                storyView.classList.remove('hidden');
                storyView.classList.add('fade-in');
                headerSubtitle.textContent = 'Ø¯Ø§Ø³ØªØ§Ù† Ø¬Ù„Ø³Ù‡ Û³Û¶';
                renderStory();
            }

            function goBackToMenu() {
                practiceView.classList.add('hidden');
                lessonView.classList.add('hidden');
                storyView.classList.add('hidden');
                resultsView.classList.add('hidden');
                mainMenuView.classList.remove('hidden');
                mainMenuView.classList.add('fade-in');
                headerSubtitle.textContent = 'ÛŒÚ© Ø¨Ø®Ø´ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ ØªÙ…Ø±ÛŒÙ† Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.';
                window.speechSynthesis.cancel();
            }

            function showResults() {
                practiceView.classList.add('hidden');
                resultsView.classList.remove('hidden');
                resultsView.classList.add('fade-in');
                headerSubtitle.textContent = 'Ù†ØªØ§ÛŒØ¬ ØªÙ…Ø±ÛŒÙ† Ø´Ù…Ø§';
                const totalCards = currentSession.cards.length;
                const knownPercentage = totalCards > 0 ? ((currentSession.knownCount / totalCards) * 100).toFixed(0) : 0;
                const unknownPercentage = totalCards > 0 ? ((currentSession.unknownCount / totalCards) * 100).toFixed(0) : 0;
                resultsStats.innerHTML = `<p class="mb-2">ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§: ${totalCards}</p><p class="text-green-600 font-bold mb-1">Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ù„Ø¯ Ø¨ÙˆØ¯Ù…: ${currentSession.knownCount} (${knownPercentage}%)</p><p class="text-red-600 font-bold">Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ù„Ø¯ Ù†Ø¨ÙˆØ¯Ù…: ${currentSession.unknownCount} (${unknownPercentage}%)</p>`;
            }

            async function saveStats() {
                if (!firebaseInitialized || !userId) {
                    saveMessage.textContent = 'Ø®Ø·Ø§: Ø§Ù…Ú©Ø§Ù† Ø°Ø®ÛŒØ±Ù‡ Ù†ØªØ§ÛŒØ¬ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.';
                    saveMessage.classList.remove('text-green-700');
                    saveMessage.classList.add('text-red-700');
                    return;
                }
                saveResultsBtn.disabled = true;
                saveResultsBtn.classList.add('opacity-50', 'cursor-not-allowed');
                saveMessage.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...';
                try {
                    const statsCollection = collection(db, `artifacts/${appId}/users/${userId}/flashcard_stats`);
                    await addDoc(statsCollection, {
                        known: currentSession.knownCount,
                        unknown: currentSession.unknownCount,
                        total: currentSession.cards.length,
                        type: currentSession.type,
                        timestamp: new Date()
                    });
                    saveMessage.textContent = 'Ù†ØªØ§ÛŒØ¬ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!  ';
                    saveMessage.classList.remove('text-red-700');
                    saveMessage.classList.add('text-green-700');
                } catch (e) {
                    console.error("Error adding document: ", e);
                    saveMessage.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù†ØªØ§ÛŒØ¬.';
                    saveMessage.classList.remove('text-green-700');
                    saveMessage.classList.add('text-red-700');
                    saveResultsBtn.disabled = false;
                    saveResultsBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }

            function navigateCards(direction) {
                const newIndex = currentSession.currentIndex + direction;
                if (newIndex >= 0 && newIndex < currentSession.cards.length) {
                    currentSession.currentIndex = newIndex;
                    showCard(newIndex);
                } else if (newIndex >= currentSession.cards.length) {
                    showResults();
                }
            }

            function handleFeedback(isKnewIt) {
                if (isKnewIt) {
                    currentSession.knownCount++;
                } else {
                    currentSession.unknownCount++;
                }
                navigateCards(1);
            }
            
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            // --- EVENT LISTENERS ---
            startLesson36Btn.addEventListener('click', showLesson);
            startStoryBtn.addEventListener('click', showStory);
            startVocabBtn.addEventListener('click', () => startPractice('vocab'));
            startGrammarBtn.addEventListener('click', () => startPractice('grammar'));
            backToMenuBtns.forEach(btn => btn.addEventListener('click', goBackToMenu));
            knewItBtn.addEventListener('click', () => handleFeedback(true));
            didNotKnowBtn.addEventListener('click', () => handleFeedback(false));
            nextCardBtn.addEventListener('click', () => navigateCards(1));
            prevCardBtn.addEventListener('click', () => navigateCards(-1));
            
            flashcardDisplay.addEventListener('click', function(event) {
                const flashcard = this.querySelector('.flashcard');
                if (event.target.closest('button')) {
                    return;
                }
                flashcard.classList.toggle('is-flipped');
                
                if (flashcard.classList.contains('is-flipped')) {
                    interactiveButtons.classList.remove('hidden');
                } else {
                    interactiveButtons.classList.add('hidden');
                }
            });

            document.body.addEventListener('click', function(event) {
                const pronunciationButton = event.target.closest('.pronunciation-button');
                if (pronunciationButton) {
                    event.stopPropagation();
                    const textToSpeak = pronunciationButton.dataset.text;
                    if (textToSpeak) {
                        speakText(textToSpeak);
                    }
                }
            });
            saveResultsBtn.addEventListener('click', saveStats);
        });
    </script>
</body>
</html>
 